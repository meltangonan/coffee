<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Coffee Journal</title>
<link rel="icon" type="image/svg+xml" href="/icons/app-icon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2C1810">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Coffee Journal">
<link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
<script>
// Polyfill for crypto.randomUUID (older browsers)
if (typeof crypto !== 'undefined' && !crypto.randomUUID) {
  crypto.randomUUID = function() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0;
      return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
  };
}
</script>
<style>
/* ═══════════════════════════════════════════
   COFFEE JOURNAL — Warm Industrial Cafe
   ═══════════════════════════════════════════ */

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
[x-cloak] { display: none !important; }

:root {
  --espresso: #2C1810;
  --espresso-light: #3D2820;
  --cream: #F5F0E8;
  --cream-dark: #EDE6DA;
  --amber: #D4A574;
  --amber-light: #E8C9A0;
  --amber-dark: #B8864E;
  --text-primary: #2C1810;
  --text-secondary: #6B5B4E;
  --text-muted: #9B8B7E;
  --freshness-resting: #8B9DAF;
  --freshness-resting-bg: rgba(139,157,175,0.12);
  --freshness-optimal: #7BA05B;
  --freshness-optimal-bg: rgba(123,160,91,0.12);
  --freshness-past: #A0695B;
  --freshness-past-bg: rgba(160,105,91,0.12);
  /* Bar colors are defined in JS BAR_COLORS array */
  --radius: 10px;
  --radius-sm: 6px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 3px rgba(44,24,16,0.06), 0 1px 2px rgba(44,24,16,0.04);
  --shadow: 0 2px 8px rgba(44,24,16,0.08), 0 1px 3px rgba(44,24,16,0.06);
  --shadow-lg: 0 4px 16px rgba(44,24,16,0.10), 0 2px 6px rgba(44,24,16,0.06);
  --shadow-xl: 0 8px 30px rgba(44,24,16,0.14), 0 4px 10px rgba(44,24,16,0.08);
  --font-heading: 'Playfair Display', 'Georgia', serif;
  --font-body: 'DM Sans', 'Helvetica Neue', sans-serif;
  --tab-height: 64px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --tab-total: calc(var(--tab-height) + var(--safe-bottom));
}

html {
  font-size: 16px;
  -webkit-text-size-adjust: 100%;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: var(--font-body);
  background: var(--cream);
  color: var(--text-primary);
  overflow-x: hidden;
  min-height: 100dvh;
  margin: 0;
  background-image:
    url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
}

.app-shell { display: flex; flex-direction: column; height: 100dvh; max-width: 600px; margin: 0 auto; position: relative; padding-top: var(--safe-top); }
/* iOS standalone: 100dvh reports height minus safe area (WebKit bug 254868). Use 100vh so layout fills screen and tab bar sticks to bottom. */
@media (display-mode: standalone) {
  html, body { min-height: 100vh; }
  .app-shell { height: 100vh; }
}
@media (min-width: 768px) { .app-shell { border-left: 1px solid rgba(44,24,16,0.06); border-right: 1px solid rgba(44,24,16,0.06); } }

.content-area { flex: 1; position: relative; overflow-y: auto; overflow-x: hidden; padding: 20px 16px; padding-bottom: calc(var(--tab-total) + 24px); -webkit-overflow-scrolling: touch; }
.tab-stage { position: relative; }
.content-top-actions { position: absolute; top: 20px; right: 16px; z-index: 40; display: flex; justify-content: flex-end; pointer-events: none; }
.backup-launch-btn { pointer-events: auto; min-height: 36px; padding: 8px 12px; font-size: 13px; }

.tab-bar { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; max-width: 600px; margin: 0 auto; height: var(--tab-total); padding-bottom: var(--safe-bottom); background: var(--espresso); display: flex; align-items: flex-start; justify-content: space-around; z-index: 100; box-shadow: 0 -2px 20px rgba(44,24,16,0.15); }
.tab-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; padding: 8px 16px; min-width: 64px; height: var(--tab-height); background: none; border: none; color: rgba(245,240,232,0.5); font-family: var(--font-body); font-size: 11px; font-weight: 500; letter-spacing: 0.3px; cursor: pointer; transition: color 0.2s ease; -webkit-tap-highlight-color: transparent; }
.tab-btn.active { color: var(--amber); }
.tab-btn:hover { color: var(--amber-light); }
.tab-icon { font-size: 22px; line-height: 1; display: block; }

.heading-xl { font-family: var(--font-heading); font-size: 28px; font-weight: 700; line-height: 1.2; color: var(--espresso); }
.heading-lg { font-family: var(--font-heading); font-size: 22px; font-weight: 600; line-height: 1.3; color: var(--espresso); }
.heading-md { font-family: var(--font-heading); font-size: 18px; font-weight: 600; line-height: 1.3; color: var(--espresso); }
.text-secondary { color: var(--text-secondary); font-size: 14px; }
.text-muted { color: var(--text-muted); font-size: 13px; }
.text-small { font-size: 13px; }



.badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; letter-spacing: 0.2px; }
.badge-resting { background: var(--freshness-resting-bg); color: var(--freshness-resting); }
.badge-optimal { background: var(--freshness-optimal-bg); color: var(--freshness-optimal); }
.badge-past { background: var(--freshness-past-bg); color: var(--freshness-past); }
.badge-archived { background: rgba(44,24,16,0.06); color: var(--text-muted); }
.badge-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

.freshness-legend { padding-bottom: 8px; }
.freshness-legend-items { background: var(--cream-dark); border-radius: var(--radius); padding: 4px 16px; }
.freshness-legend-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; }
.freshness-legend-item + .freshness-legend-item { border-top: 1px solid rgba(44,24,16,0.06); }
.freshness-legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }
.freshness-legend-dot.resting { background: var(--freshness-resting); }
.freshness-legend-dot.at-peak { background: var(--freshness-optimal); }
.freshness-legend-dot.past-peak { background: var(--freshness-past); }
.freshness-legend-text { display: flex; flex-direction: column; gap: 1px; }
.freshness-legend-label { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.freshness-legend-days { font-size: 11px; font-weight: 500; color: var(--text-muted); }
.freshness-legend-desc { font-size: 12px; color: var(--text-secondary); line-height: 1.4; margin-top: 2px; }

.btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; min-height: 44px; border: none; border-radius: var(--radius); font-family: var(--font-body); font-size: 15px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
.btn-primary { background: var(--espresso); color: var(--cream); }
.btn-primary:hover { background: var(--espresso-light); transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-primary:active { transform: translateY(0); }
.btn-amber { background: var(--amber); color: var(--espresso); font-weight: 600; }
.btn-amber:hover { background: var(--amber-dark); color: white; }
.btn-ghost { background: transparent; color: var(--text-secondary); padding: 12px 16px; }
.btn-ghost:hover { background: rgba(44,24,16,0.04); }
.btn-secondary-solid { background: rgba(44,24,16,0.08); color: var(--text-primary); padding: 12px 16px; }
.btn-secondary-solid:hover { background: rgba(44,24,16,0.14); color: var(--text-primary); }
.btn-danger { background: transparent; color: var(--freshness-past); font-size: 14px; }
.btn-danger:hover { background: var(--freshness-past-bg); }
.btn-danger-solid { background: var(--freshness-past); color: var(--cream); font-size: 14px; }
.btn-danger-solid:hover { background: #8B5A4F; color: var(--cream); }

/* Bean detail actions: archive = light gray, delete = red highlight */
.btn-archive-highlight { background: rgba(0,0,0,0.06) !important; color: var(--text-secondary); }
.btn-archive-highlight:hover { background: rgba(0,0,0,0.10) !important; }
.btn-delete-highlight { background: rgba(180, 70, 60, 0.15) !important; color: #a04038; }
.btn-delete-highlight:hover { background: rgba(180, 70, 60, 0.25) !important; }

.btn-full { width: 100%; }

.fab { position: fixed; bottom: calc(var(--tab-total) + 20px); right: max(16px, calc(50% - 284px)); height: 52px; padding: 0 20px 0 16px; border-radius: 26px; background: var(--amber); color: var(--espresso); border: none; font-family: var(--font-body); font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-xl); cursor: pointer; z-index: 50; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
.fab-icon { font-size: 22px; line-height: 1; font-weight: 400; }
.fab:hover { transform: scale(1.04); background: var(--amber-dark); color: white; }
.fab:active { transform: scale(0.97); }

.form-group { margin-bottom: 18px; }
.form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; letter-spacing: 0.3px; text-transform: uppercase; }
.form-label .required { color: var(--freshness-past); margin-left: 2px; }
.form-input { width: 100%; padding: 12px 14px; min-height: 44px; border: 1.5px solid rgba(44,24,16,0.12); border-radius: var(--radius); font-family: var(--font-body); font-size: 16px; color: var(--text-primary); background: white; transition: border-color 0.2s ease, box-shadow 0.2s ease; -webkit-appearance: none; appearance: none; }
.form-input:focus { outline: none; border-color: var(--amber); box-shadow: 0 0 0 3px rgba(212,165,116,0.15); }
.form-input::placeholder { color: var(--text-muted); }
textarea.form-input { min-height: 80px; resize: vertical; line-height: 1.5; }

/* Custom date picker */
.date-picker-group { position: relative; }
.date-input-wrapper { position: relative; cursor: pointer; }
.date-input-wrapper .form-input { cursor: pointer; padding-right: 44px; }
.date-input-actions { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; gap: 2px; }
.date-clear-btn { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 50%; transition: background 0.15s ease, color 0.15s ease; font-size: 16px; line-height: 1; padding: 0; -webkit-tap-highlight-color: transparent; }
.date-clear-btn:hover { background: rgba(44,24,16,0.06); color: var(--text-secondary); }
.date-clear-btn:active { background: rgba(44,24,16,0.1); }

/* Custom calendar picker */
.custom-datepicker { background: #FFFCF7; border: 1.5px solid rgba(44,24,16,0.1); border-radius: var(--radius-lg); box-shadow: 0 12px 40px rgba(44,24,16,0.15), 0 4px 12px rgba(44,24,16,0.08); padding: 0; overflow: visible; min-width: 300px; position: absolute; top: calc(100% + 8px); left: 0; z-index: 200; }
.datepicker-nav { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px 10px; }
.datepicker-month-year { font-family: var(--font-heading); font-size: 17px; font-weight: 600; color: var(--espresso); letter-spacing: -0.01em; }
.datepicker-nav-actions { display: flex; align-items: center; gap: 4px; }
.datepicker-clear-btn { padding: 6px 12px; font-family: var(--font-body); font-size: 13px; font-weight: 500; color: var(--text-muted); background: transparent; border: none; cursor: pointer; border-radius: var(--radius-sm); transition: color 0.15s ease, background 0.15s ease; }
.datepicker-clear-btn:hover { color: var(--freshness-past); background: var(--freshness-past-bg); }
.datepicker-nav-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: rgba(44,24,16,0.05); border: none; color: var(--text-secondary); cursor: pointer; border-radius: 50%; transition: color 0.15s ease, background 0.15s ease; font-size: 16px; }
.datepicker-nav-btn:hover { color: var(--espresso); background: rgba(212,165,116,0.2); }
.datepicker-today-btn { padding: 6px 12px; font-family: var(--font-body); font-size: 13px; font-weight: 500; color: var(--amber-dark); background: transparent; border: none; cursor: pointer; border-radius: var(--radius-sm); transition: color 0.15s ease, background 0.15s ease; }
.datepicker-today-btn:hover { color: var(--espresso); background: rgba(212,165,116,0.2); }
.datepicker-footer { display: flex; justify-content: flex-end; padding: 8px 12px 14px; border-top: 1px solid rgba(44,24,16,0.06); margin: 0 4px; }
.datepicker-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); padding: 4px 12px 8px; border-bottom: 1px solid rgba(44,24,16,0.06); margin: 0 4px; }
.datepicker-weekday { font-family: var(--font-body); font-size: 11px; font-weight: 600; color: var(--text-muted); text-align: center; text-transform: uppercase; letter-spacing: 0.5px; padding: 4px 0; }
.datepicker-days { display: grid; grid-template-columns: repeat(7, 1fr); padding: 8px 12px 14px; gap: 2px; }
.datepicker-day { font-family: var(--font-body); font-size: 14px; font-weight: 400; color: var(--text-primary); background: transparent; border: none; cursor: pointer; border-radius: 50%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; transition: background 0.15s ease, color 0.15s ease, transform 0.1s ease; }
.datepicker-day:hover:not(.outside):not(.today):not(.selected) { background: rgba(212,165,116,0.15); }
.datepicker-day:active:not(.outside) { transform: scale(0.92); }
.datepicker-day.outside { color: var(--text-muted); opacity: 0.4; cursor: default; }
.datepicker-day.outside:hover { background: transparent; }
.datepicker-day.today { background: rgba(212,165,116,0.15); color: var(--amber-dark); font-weight: 600; }
.datepicker-day.selected { background: var(--amber-dark); color: white; font-weight: 600; box-shadow: 0 2px 8px rgba(184,134,78,0.3); }
.datepicker-day.today.selected { background: var(--amber-dark); color: white; }

.stepper { display: flex; align-items: center; gap: 0; border: 1.5px solid rgba(44,24,16,0.12); border-radius: var(--radius); background: white; overflow: hidden; }
.stepper-btn { width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: var(--text-primary); background: transparent; border: none; cursor: pointer; transition: background 0.15s ease; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
.stepper-btn:hover:not(:disabled) { background: rgba(44,24,16,0.06); }
.stepper-btn:active:not(:disabled) { background: rgba(44,24,16,0.1); }
.stepper-btn:disabled { opacity: 0.4; cursor: not-allowed; }
.stepper-input { flex: 1; min-width: 0; padding: 12px 8px; border: none; border-left: 1.5px solid rgba(44,24,16,0.08); border-right: 1.5px solid rgba(44,24,16,0.08); font-family: var(--font-body); font-size: 16px; color: var(--text-primary); background: transparent; text-align: center; -webkit-appearance: none; -moz-appearance: textfield; appearance: textfield; }
.stepper-input::-webkit-outer-spin-button, .stepper-input::-webkit-inner-spin-button { -webkit-appearance: none; appearance: none; margin: 0; }
.stepper-input:focus { outline: none; }
.stepper-input::placeholder { color: var(--text-muted); }

.star-rating { display: inline-flex; gap: 2px; }
.star { font-size: 20px; cursor: pointer; color: var(--text-muted); transition: color 0.15s ease, transform 0.15s ease; user-select: none; -webkit-tap-highlight-color: transparent; padding: 2px; min-width: 28px; min-height: 28px; display: inline-flex; align-items: center; justify-content: center; }
.star.filled { color: var(--amber); filter: drop-shadow(0 0 0.5px rgba(44,24,16,0.2)); }
.star:hover { transform: scale(1.15); }
.star-display { display: inline-flex; gap: 1px; font-size: 14px; }
.star-display .star { font-size: 14px; cursor: default; padding: 0; min-width: auto; min-height: auto; }
.star-display .star:hover { transform: none; }
.bean-detail-stars { padding: 12px 14px; background: var(--cream-dark); border-radius: var(--radius-sm); border: 1px solid rgba(44,24,16,0.06); }

/* Shot quality: Bad / Okay / Great / Perfect */
.shot-quality-options { display: flex; gap: 8px; flex-wrap: wrap; }
.shot-quality-btn { padding: 10px 18px; border-radius: var(--radius); border: 1.5px solid rgba(44,24,16,0.15); background: white; font-family: var(--font-body); font-size: 14px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
.shot-quality-btn:hover { border-color: var(--amber); color: var(--text-primary); }
.shot-quality-btn.active { border-color: var(--amber); background: rgba(212,165,116,0.15); color: var(--amber-dark); }
.shot-quality-btn.bad.active { border-color: var(--freshness-past); background: var(--freshness-past-bg); color: var(--freshness-past); }
.shot-quality-btn.okay.active { border-color: var(--amber-dark); background: rgba(212,165,116,0.18); color: var(--amber-dark); }
.shot-quality-btn.great.active { border-color: #4F6FA5; background: rgba(79,111,165,0.14); color: #3F5A86; }
.shot-quality-btn.perfect.active { border-color: var(--freshness-optimal); background: var(--freshness-optimal-bg); color: var(--freshness-optimal); }
.shot-quality-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
.shot-quality-badge.bad { background: var(--freshness-past-bg); color: var(--freshness-past); }
.shot-quality-badge.okay { background: rgba(212,165,116,0.18); color: var(--amber-dark); }
.shot-quality-badge.great { background: rgba(79,111,165,0.14); color: #3F5A86; }
.shot-quality-badge.perfect { background: var(--freshness-optimal-bg); color: var(--freshness-optimal); }
.shot-assessment { font-size: 12px; font-weight: 500; margin-top: 3px; white-space: pre-line; }
.shot-assessment.good { color: var(--freshness-optimal); }
.shot-assessment.warning { color: var(--freshness-past); }

/* Shot rating row: inline rating buttons + date picker */
.shot-rating-row { display: flex; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
.shot-rating-row .shot-quality-options { flex: 1; min-width: 200px; }
.shot-rating-row .shot-date-picker { flex: 0 0 auto; min-width: 140px; }
.shot-date-picker .date-input-wrapper .form-input { font-size: 13px; padding: 8px 36px 8px 10px; }
/* Date pickers in modals/forms: use fixed positioning centered on screen */
.shot-date-picker .custom-datepicker,
.panel .date-picker-group .custom-datepicker,
.content-area .date-picker-group .custom-datepicker { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }

.toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }
.toggle { position: relative; width: 48px; height: 28px; background: rgba(44,24,16,0.12); border-radius: 14px; border: none; cursor: pointer; transition: background 0.2s ease; -webkit-tap-highlight-color: transparent; }
.toggle.active { background: var(--amber); }
.toggle::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; box-shadow: var(--shadow-sm); transition: transform 0.2s ease; }
.toggle.active::after { transform: translateX(20px); }

.overlay { position: fixed; inset: 0; background: rgba(44,24,16,0.4); z-index: 200; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px); padding: 16px; }
.panel { background: var(--cream); border-radius: var(--radius-lg); width: 100%; max-width: 600px; max-height: 85vh; overflow-y: auto; padding: 24px 16px; padding-bottom: calc(24px + var(--safe-bottom)); box-shadow: var(--shadow-xl); animation: modalIn 0.25s ease-out; }
@keyframes modalIn { from { transform: scale(0.96); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.delete-confirm-panel { max-width: 420px; padding: 24px 18px calc(24px + var(--safe-bottom)); }
.delete-confirm-icon { width: 44px; height: 44px; border-radius: 50%; background: var(--freshness-past-bg); color: var(--freshness-past); display: flex; align-items: center; justify-content: center; margin: 0 auto 14px; font-size: 22px; }
.delete-confirm-title { text-align: center; margin-bottom: 8px; }
.delete-confirm-copy { color: var(--text-secondary); font-size: 14px; line-height: 1.5; text-align: center; }
.delete-confirm-copy strong { color: var(--text-primary); font-weight: 600; }
.delete-confirm-actions { display: flex; gap: 10px; margin-top: 20px; }
.delete-confirm-actions .btn { flex: 1; }

.divider { height: 1px; background: rgba(44,24,16,0.08); margin: 16px 0; }

.empty-state { text-align: center; padding: 48px 24px; }
.empty-state-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
.empty-state-title { font-family: var(--font-heading); font-size: 20px; color: var(--text-secondary); margin-bottom: 8px; }
.empty-state-text { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; line-height: 1.5; }

/* Today tab — no beans onboarding state */
.today-no-beans-state { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 60px 24px 48px; min-height: calc(100dvh - var(--tab-total) - var(--safe-top) - 80px); }
.today-no-beans-icon { width: 96px; height: 96px; margin-bottom: 24px; opacity: 0.85; }
.today-no-beans-icon svg { width: 100%; height: 100%; }
.today-no-beans-title { font-family: var(--font-heading); font-size: 26px; font-weight: 600; color: var(--espresso); margin-bottom: 12px; line-height: 1.2; }
.today-no-beans-text { color: var(--text-secondary); font-size: 15px; line-height: 1.6; margin-bottom: 28px; max-width: 280px; }

/* Restore from archive */
.restore-from-archive { margin-top: 20px; width: 100%; max-width: 300px; }
.restore-toggle { display: inline-flex; align-items: center; gap: 8px; background: none; border: none; color: var(--text-muted); font-family: var(--font-body); font-size: 14px; cursor: pointer; padding: 8px 16px; border-radius: var(--radius); transition: color 0.2s ease, background 0.2s ease; -webkit-tap-highlight-color: transparent; }
.restore-toggle:hover { color: var(--text-secondary); background: rgba(44,24,16,0.04); }
.restore-toggle-icon { font-size: 16px; }
.archive-picker { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); border: 1px solid rgba(44,24,16,0.08); overflow: hidden; animation: archiveSlideIn 0.2s ease-out; }
@keyframes archiveSlideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
.archive-picker-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(44,24,16,0.06); background: var(--cream-dark); }
.archive-picker-title { font-family: var(--font-body); font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
.archive-picker-close { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; border-radius: 50%; transition: background 0.15s ease, color 0.15s ease; -webkit-tap-highlight-color: transparent; }
.archive-picker-close:hover { background: rgba(44,24,16,0.08); color: var(--text-primary); }
.archive-picker-list { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.archive-picker-item { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; width: 100%; padding: 14px 16px; background: none; border: none; border-bottom: 1px solid rgba(44,24,16,0.04); text-align: left; cursor: pointer; transition: background 0.15s ease; -webkit-tap-highlight-color: transparent; font-family: var(--font-body); }
.archive-picker-item:last-child { border-bottom: none; }
.archive-picker-item:hover { background: rgba(212,165,116,0.1); }
.archive-picker-item:active { background: rgba(212,165,116,0.2); }
.archive-picker-name { font-size: 15px; font-weight: 500; color: var(--text-primary); }
.archive-picker-roaster { font-size: 13px; color: var(--text-muted); }
.archive-picker-footer { padding: 10px 16px 14px; border-top: 1px solid rgba(44,24,16,0.06); }
.archive-picker-view-all { width: 100%; padding: 10px; background: none; border: 1.5px dashed rgba(44,24,16,0.15); border-radius: var(--radius-sm); font-family: var(--font-body); font-size: 13px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.15s ease; -webkit-tap-highlight-color: transparent; }
.archive-picker-view-all:hover { border-color: var(--amber); color: var(--amber-dark); background: rgba(212,165,116,0.08); }

/* Duplicate bean button — subtle, icon-style */
.btn-duplicate {
  width: 36px; height: 36px; padding: 0;
  display: flex; align-items: center; justify-content: center;
  background: transparent; border: 1.5px solid rgba(44,24,16,0.12);
  border-radius: var(--radius-sm); color: var(--text-muted);
  cursor: pointer; transition: all 0.2s ease;
  -webkit-tap-highlight-color: transparent;
}
.btn-duplicate:hover { border-color: var(--amber); color: var(--amber-dark); background: rgba(212,165,116,0.08); }
.btn-duplicate:active { transform: scale(0.95); }
.btn-duplicate svg { width: 16px; height: 16px; }

/* Fill from previous — CTA in Add Bean form */
.fill-from-previous { position: relative; }
.fill-from-previous-trigger {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 14px 16px;
  background: rgba(212,165,116,0.08);
  border: 1.5px dashed var(--amber);
  border-radius: var(--radius);
  font-family: var(--font-body); font-size: 14px; font-weight: 500;
  color: var(--amber-dark); cursor: pointer;
  transition: all 0.2s ease;
  -webkit-tap-highlight-color: transparent;
}
.fill-from-previous-trigger:hover {
  background: rgba(212,165,116,0.15);
  border-color: var(--amber-dark);
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(212,165,116,0.2);
}
.fill-from-previous-trigger:active { transform: translateY(0); }
.fill-from-previous-trigger svg { width: 16px; height: 16px; }
.fill-from-previous-picker {
  position: absolute; top: calc(100% + 8px); left: 0; right: 0;
  background: white; border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg); border: 1px solid rgba(44,24,16,0.08);
  overflow: hidden; z-index: 100;
  animation: archiveSlideIn 0.2s ease-out;
}

.date-header { margin-bottom: 24px; }
.date-header .day-name { font-family: var(--font-heading); font-size: 32px; font-weight: 700; color: var(--espresso); line-height: 1.1; }
.date-header .date-sub { font-size: 15px; color: var(--text-secondary); margin-top: 4px; }

.bean-card { position: relative; background: white; border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); border: 1px solid rgba(44,24,16,0.04); margin-bottom: 12px; cursor: pointer; transition: all 0.2s ease; -webkit-tap-highlight-color: transparent; }
.bean-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-1px); }
.bean-card:active { transform: translateY(0); }
.bean-card.archived { opacity: 0.55; background: var(--cream-dark); }
.bean-card.archived:hover { opacity: 0.7; }
.bean-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px; }
.bean-card-name { font-family: var(--font-heading); font-size: 18px; font-weight: 600; color: var(--espresso); line-height: 1.3; }
.bean-card-roaster { font-size: 14px; color: var(--text-secondary); }
.bean-card-roast-date { font-size: 12px; color: var(--text-muted); margin-top: 2px; margin-bottom: 10px; }
.bean-card-footer { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.best-recipe-indicator { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; color: var(--amber-dark); font-weight: 500; }
.bean-card-occurrence { position: absolute; bottom: 12px; right: 12px; min-width: 18px; height: 18px; padding: 0 5px; display: flex; align-items: center; justify-content: center; background: rgba(44,24,16,0.04); border-radius: 9px; font-family: var(--font-body); font-size: 10px; font-weight: 500; color: var(--text-muted); }
.beans-section-label { font-family: var(--font-body); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin: 20px 0 10px; }
.beans-section-label:first-of-type { margin-top: 0; }
.beans-section-header { display: flex; align-items: center; justify-content: space-between; margin: 20px 0 10px; }
.beans-section-header:first-of-type { margin-top: 0; }
.beans-section-header .beans-section-label { margin: 0; }
.beans-section-link { font-family: var(--font-body); font-size: 12px; font-weight: 500; color: var(--amber-dark); background: none; border: none; cursor: pointer; padding: 4px 8px; margin: -4px -8px; border-radius: var(--radius-sm); transition: background 0.15s ease; -webkit-tap-highlight-color: transparent; }
.beans-section-link:hover { background: rgba(212,165,116,0.15); }

/* Archive View */
.archive-view-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.archive-view-title { flex: 1; }

.detail-header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
.back-btn { width: 40px; height: 40px; min-width: 40px; display: flex; align-items: center; justify-content: center; border: none; background: rgba(44,24,16,0.06); border-radius: 50%; font-size: 18px; cursor: pointer; color: var(--text-primary); transition: background 0.2s ease; -webkit-tap-highlight-color: transparent; }
.back-btn:hover { background: rgba(44,24,16,0.1); }

.freshness-display { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border-radius: var(--radius); margin-bottom: 16px; }
.freshness-display.resting { background: var(--freshness-resting-bg); }
.freshness-display.optimal { background: var(--freshness-optimal-bg); }
.freshness-display.past { background: var(--freshness-past-bg); }
.freshness-icon { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.freshness-display.resting .freshness-icon { background: var(--freshness-resting); }
.freshness-display.optimal .freshness-icon { background: var(--freshness-optimal); }
.freshness-display.past .freshness-icon { background: var(--freshness-past); }
.freshness-text { font-size: 14px; font-weight: 500; }

.recipe-card { background: linear-gradient(135deg, var(--espresso) 0%, var(--espresso-light) 100%); border-radius: var(--radius-lg); padding: 20px; color: var(--cream); margin-bottom: 20px; position: relative; overflow: hidden; }
.recipe-card::before { content: ''; position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(212,165,116,0.1); border-radius: 50%; }
.recipe-card-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--amber); margin-bottom: 12px; }
.recipe-card-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
.recipe-stat-label { font-size: 11px; color: rgba(245,240,232,0.6); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.recipe-stat-value { font-family: var(--font-heading); font-size: 22px; font-weight: 600; }
.recipe-card-edit { margin-top: 14px; color: var(--amber); font-size: 13px; padding: 6px 0; }
.recipe-card-edit-form .stepper-dark { background: var(--cream); border: 1px solid rgba(44,24,16,0.2); }
.recipe-card-edit-form .stepper-dark .stepper-btn { color: var(--espresso); font-weight: 500; }
.recipe-card-edit-form .stepper-dark .stepper-btn:hover:not(:disabled) { background: var(--cream-dark); color: var(--espresso); }
.recipe-card-edit-form .stepper-dark .stepper-btn:disabled { opacity: 0.4; color: var(--text-muted); }
.recipe-card-edit-form .stepper-dark .stepper-input { color: var(--espresso); font-size: 17px; font-weight: 600; border-left-color: rgba(44,24,16,0.12); border-right-color: rgba(44,24,16,0.12); }
.recipe-card-edit-form .stepper-dark .stepper-input::placeholder { color: var(--text-muted); }
.recipe-card-edit-form .btn-cancel { background: rgba(245,240,232,0.15); color: var(--cream); }
.recipe-card-edit-form .btn-cancel:hover { background: rgba(245,240,232,0.25); }


.shot-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(44,24,16,0.06); }
.shot-row:last-child { border-bottom: none; }
.shot-info { display: flex; flex-direction: column; gap: 3px; min-width: 0; flex: 1; }
.shot-settings { font-size: 14px; font-weight: 500; color: var(--text-primary); }
.shot-date { font-size: 12px; color: var(--text-muted); }
.shot-meta { display: flex; align-items: center; gap: 8px; }
.best-recipe-star { color: var(--amber); font-size: 16px; }

.daily-bean-selector { margin-bottom: 20px; position: relative; }
.bean-picker-trigger { width: 100%; padding: 14px 16px; min-height: 48px; border: 2px solid rgba(44,24,16,0.12); border-radius: var(--radius); font-family: var(--font-body); font-size: 16px; color: var(--text-primary); background: white; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 12px; transition: border-color 0.2s ease, box-shadow 0.2s ease; -webkit-tap-highlight-color: transparent; }
.bean-picker-trigger:focus, .bean-picker-trigger.open { outline: none; border-color: var(--amber); box-shadow: 0 0 0 3px rgba(212,165,116,0.15); }
.bean-picker-trigger .picker-placeholder { color: var(--text-muted); }
.bean-picker-trigger .picker-selected { display: flex; align-items: center; gap: 10px; min-width: 0; }
.bean-picker-trigger .picker-selected-name { font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bean-picker-trigger .picker-selected-roaster { font-size: 13px; color: var(--text-secondary); white-space: nowrap; }
.bean-picker-chevron { flex-shrink: 0; width: 18px; height: 18px; color: var(--text-muted); transition: transform 0.25s ease; }
.bean-picker-trigger.open .bean-picker-chevron { transform: rotate(180deg); }
.bean-picker-dropdown { position: absolute; top: calc(100% + 6px); left: 0; right: 0; z-index: 50; background: #FFFCF7; border: 1.5px solid rgba(44,24,16,0.1); border-radius: var(--radius-lg); box-shadow: 0 12px 40px rgba(44,24,16,0.15), 0 4px 12px rgba(44,24,16,0.08); max-height: 280px; overflow-y: auto; padding: 6px; opacity: 0; transform: translateY(-6px); transition: opacity 0.2s ease, transform 0.2s ease; pointer-events: none; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
.bean-picker-dropdown.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
.bean-picker-option { display: flex; align-items: center; gap: 12px; padding: 12px 12px; border-radius: var(--radius); cursor: pointer; transition: background 0.15s ease; -webkit-tap-highlight-color: transparent; }
.bean-picker-option:hover, .bean-picker-option:focus { background: rgba(212,165,116,0.1); outline: none; }
.bean-picker-option:active { background: rgba(212,165,116,0.18); }
.bean-picker-option.selected { background: rgba(212,165,116,0.12); }
.bean-picker-option.add-new { margin-top: 4px; padding-top: 14px; border-top: 1px solid rgba(44,24,16,0.08); }
.bean-picker-add-icon { font-size: 18px; color: var(--amber-dark); line-height: 1; width: 14px; text-align: center; }
.bean-picker-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; border: 1.5px solid rgba(44,24,16,0.1); }
.bean-picker-dot.resting { background: var(--freshness-resting); border-color: var(--freshness-resting); }
.bean-picker-dot.optimal { background: var(--freshness-optimal); border-color: var(--freshness-optimal); }
.bean-picker-dot.past { background: var(--freshness-past); border-color: var(--freshness-past); }
.bean-picker-info { min-width: 0; flex: 1; }
.bean-picker-name { font-family: var(--font-body); font-size: 15px; font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.bean-picker-meta { font-size: 12px; color: var(--text-secondary); margin-top: 1px; display: flex; align-items: center; gap: 6px; }
.bean-picker-freshness { font-size: 11px; font-weight: 500; padding: 1px 6px; border-radius: 4px; }
.bean-picker-freshness.resting { color: var(--freshness-resting); background: var(--freshness-resting-bg); }
.bean-picker-freshness.optimal { color: var(--freshness-optimal); background: var(--freshness-optimal-bg); }
.bean-picker-freshness.past { color: var(--freshness-past); background: var(--freshness-past-bg); }

.btn.btn-action-small { flex: 0 0 auto; min-height: 44px; padding: 8px 14px; font-size: 14px; }

.today-shot-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; background: white; border-radius: var(--radius); margin-bottom: 8px; box-shadow: var(--shadow-sm); }
.today-shot-content { flex: 1; min-width: 0; cursor: pointer; }
.today-shot-bean { font-weight: 600; font-size: 14px; color: var(--espresso); }
.today-shot-details { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
.today-shot-meta { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.today-shot-delete-confirm { padding: 4px 10px; font-size: 12px; color: white; background: var(--freshness-past); border-radius: var(--radius-sm); font-weight: 500; }
.today-shot-delete { padding: 4px 8px; font-size: 12px; color: var(--text-muted); }
.today-shot-delete:hover { color: var(--freshness-past); }
/* Swipe-to-delete wrapper (touch) */
.today-shot-swipe { position: relative; overflow: hidden; border-radius: var(--radius); margin-bottom: 8px; }
.today-shot-swipe-actions { position: absolute; top: 0; right: 0; bottom: 0; width: 72px; display: flex; align-items: center; justify-content: center; background: var(--freshness-past); color: white; font-size: 13px; font-weight: 500; }
.today-shot-swipe-content { position: relative; z-index: 1; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm); transition: transform 0.2s ease; touch-action: pan-y; }
.today-shot-swipe-content.reveal { transform: translateX(-72px); }
.bean-shot-swipe-row { padding: 14px 16px; border-bottom: none; }

.calendar-description { color: var(--text-muted); font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
.calendar-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 24px; max-width: 460px; margin: 0 auto; }
.calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.calendar-nav { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border: none; background: rgba(44,24,16,0.04); border-radius: 50%; font-size: 16px; cursor: pointer; color: var(--text-secondary); transition: background 0.2s ease, transform 0.15s ease; -webkit-tap-highlight-color: transparent; }
.calendar-nav:hover { background: rgba(44,24,16,0.08); transform: scale(1.06); }
.calendar-month-label { font-family: var(--font-heading); font-size: 24px; font-weight: 600; color: var(--espresso); letter-spacing: -0.01em; }
.calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 2px; padding-bottom: 8px; border-bottom: 1px solid var(--cream-dark); }
.calendar-weekday { font-family: var(--font-body); font-size: 11px; font-weight: 500; color: var(--text-muted); padding: 4px 0; text-transform: uppercase; letter-spacing: 1px; }
.calendar-grid { display: flex; flex-direction: column; gap: 0; padding-top: 4px; }
.calendar-row { position: relative; display: grid; grid-template-columns: repeat(7, 1fr); min-height: 44px; }
.calendar-cell { display: flex; align-items: center; justify-content: center; font-family: var(--font-body); font-size: 14px; font-weight: 400; color: var(--text-primary); padding: 4px 0; position: relative; z-index: 2; }
.calendar-cell span { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; transition: background 0.15s ease; }
.calendar-cell.empty { color: transparent; }
.calendar-cell.today span { font-weight: 600; color: white; background: var(--amber-dark); }
.calendar-range-bands { position: absolute; left: 0; right: 0; top: 0; bottom: 0; z-index: 1; pointer-events: none; }
.calendar-range-band { position: absolute; top: 0; bottom: 0; z-index: 1; }
.calendar-legend { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 18px; padding-top: 16px; border-top: 1px solid var(--cream-dark); }
.calendar-empty-state { margin-top: 18px; padding-top: 16px !important; border-top: 1px solid var(--cream-dark); }
.calendar-note { font-size: 12px; color: var(--text-muted); line-height: 1.45; margin-top: 18px; padding-top: 14px; border-top: 1px solid var(--cream-dark); }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: opacity 0.2s ease; -webkit-tap-highlight-color: transparent; user-select: none; border: 0; background: transparent; padding: 0; font-family: inherit; line-height: inherit; appearance: none; text-align: left; }
.legend-item:focus-visible { outline: 2px solid var(--amber-dark); outline-offset: 3px; border-radius: var(--radius-sm); }
.legend-item.dimmed { opacity: 0.3; }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; transition: background 0.2s ease; }

/* Backup tab */
.backup-description { color: var(--text-muted); font-size: 14px; line-height: 1.5; margin-bottom: 20px; }
.backup-card { background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 18px; margin-bottom: 14px; }
.backup-card-title { font-family: var(--font-heading); font-size: 21px; font-weight: 600; color: var(--espresso); margin-bottom: 6px; }
.backup-subtle { font-size: 13px; color: var(--text-secondary); line-height: 1.5; margin-bottom: 12px; }
.backup-status-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin-top: 14px; align-items: stretch; }
.backup-status-item { background: var(--cream-dark); border-radius: var(--radius); padding: 10px 12px; min-height: 72px; display: flex; flex-direction: column; justify-content: center; }
.backup-status-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 4px; }
.backup-status-value { font-size: 13px; font-weight: 500; color: var(--text-primary); }
.backup-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; align-items: stretch; }
.backup-actions .btn { flex: 1 1 0; min-width: 160px; }
.backup-help { margin-top: 10px; font-size: 12px; color: var(--text-muted); line-height: 1.45; }
.backup-alert { border-radius: var(--radius); padding: 12px 14px; margin-top: 12px; font-size: 13px; line-height: 1.45; }
.backup-alert.success { background: var(--freshness-optimal-bg); color: var(--freshness-optimal); }
.backup-alert.error { background: var(--freshness-past-bg); color: var(--freshness-past); }
.backup-alert.info { background: rgba(139,157,175,0.14); color: var(--freshness-resting); }
.backup-import-input { display: none; }
.backup-preview { margin-top: 14px; border: 1px solid rgba(44,24,16,0.08); border-radius: var(--radius); padding: 12px; background: #fffdf8; }
.backup-preview-title { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
.backup-preview-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.backup-preview-kv { background: rgba(44,24,16,0.03); border-radius: var(--radius-sm); padding: 8px 10px; }
.backup-preview-kv-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.backup-preview-kv-value { font-size: 13px; color: var(--text-primary); font-weight: 500; margin-top: 2px; }
.backup-preview-actions { display: flex; gap: 10px; margin-top: 12px; }
.backup-howto-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 12px; }
.backup-step { border: 1px solid rgba(44,24,16,0.08); border-radius: var(--radius); padding: 12px; background: #fffdf8; }
.backup-step-head { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.backup-step-num { width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; background: var(--amber); color: var(--espresso); font-size: 12px; font-weight: 700; }
.backup-step-title { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.backup-step-copy { font-size: 13px; color: var(--text-secondary); line-height: 1.45; }
.backup-steps-heading { font-size: 15px; font-weight: 600; color: var(--espresso); margin-top: 14px; margin-bottom: 10px; }
.backup-steps-heading:first-child { margin-top: 0; }

/* Layout utilities */
.form-actions { display: flex; gap: 10px; margin-top: 8px; }
.form-actions .btn:first-child { flex: 1; }
.form-actions .btn:last-child { flex: 0.6; }

/* Spacing utilities */
.mb-8 { margin-bottom: 8px; }
.mb-12 { margin-bottom: 12px; }
.mb-16 { margin-bottom: 16px; }
.mb-20 { margin-bottom: 20px; }
.mb-24 { margin-bottom: 24px; }
.mt-24 { margin-top: 24px; }

@media (max-width: 480px) {
  .delete-confirm-actions { flex-direction: column-reverse; }
  .backup-status-grid,
  .backup-preview-grid { grid-template-columns: 1fr; }
  .backup-preview-actions,
  .backup-actions { flex-direction: column; }
}

@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.fade-in { animation: fadeIn 0.3s ease-out; }

@media (min-width: 768px) {
  .content-area { padding: 28px 24px; padding-bottom: calc(var(--tab-total) + 32px); }
  .content-top-actions { top: 28px; right: 24px; }
  .heading-xl { font-size: 34px; }
  .date-header .day-name { font-size: 38px; }
}

/* Best dial-in checkbox + comparison panel */
.best-dialin-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px; cursor: pointer; }
.best-dialin-toggle input[type="checkbox"] { accent-color: var(--amber); width: 16px; height: 16px; cursor: pointer; }
.best-dialin-toggle span { font-size: 13px; color: var(--text-secondary); font-weight: 500; user-select: none; }
.best-dialin-comparison { background: rgba(212,165,116,0.08); border: 1px solid rgba(212,165,116,0.2); border-radius: var(--radius-sm); padding: 12px; margin-top: 10px; }
.best-dialin-comparison-title { font-size: 13px; font-weight: 600; color: var(--espresso); margin-bottom: 8px; }
.best-dialin-comparison-table { width: 100%; font-size: 12px; border-collapse: collapse; }
.best-dialin-comparison-table th { font-weight: 500; color: var(--text-secondary); text-align: left; padding: 3px 0; }
.best-dialin-comparison-table th:nth-child(2),
.best-dialin-comparison-table th:nth-child(3) { text-align: right; }
.best-dialin-comparison-table td { padding: 3px 0; color: var(--espresso); }
.best-dialin-comparison-table td:nth-child(2),
.best-dialin-comparison-table td:nth-child(3) { text-align: right; }
.best-dialin-comparison-table td:nth-child(3) { font-weight: 600; color: var(--amber-dark); }
.best-dialin-same { font-size: 12px; color: var(--text-secondary); text-align: center; padding: 4px 0; }
</style>
</head>
<body>

<div class="app-shell" x-data="app()" x-init="init()">

  <div class="content-area"
       @touchstart="onTabSwipeStart($event)"
       @touchmove="onTabSwipeMove($event)"
       @touchend="onTabSwipeEnd($event)"
       @touchcancel="resetTabSwipe()">
    <div class="content-top-actions">
      <button x-show="currentTab === 'today' && !showBackupPanel" class="btn btn-secondary-solid backup-launch-btn" @click="openBackupPanel()">Backup</button>
    </div>
    <div class="tab-stage">

    <!-- ═══════════════════════════════════════
         TODAY TAB — Daily Log
         ═══════════════════════════════════════ -->
    <div x-cloak class="tab-pane" :style="tabPaneStyle('today')">

      <!-- No Beans Empty State — shown when user has no active beans -->
      <template x-if="currentBeans.length === 0">
        <div class="today-no-beans-state" x-data="{ showArchive: false }">
          <div class="today-no-beans-icon">
            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
              <ellipse cx="32" cy="48" rx="20" ry="4" fill="var(--cream-dark)"/>
              <path d="M20 22c0-6.627 5.373-12 12-12s12 5.373 12 12v20c0 4.418-5.373 8-12 8s-12-3.582-12-8V22z" fill="var(--amber-light)" stroke="var(--amber-dark)" stroke-width="2"/>
              <ellipse cx="32" cy="22" rx="12" ry="5" fill="var(--amber)" stroke="var(--amber-dark)" stroke-width="2"/>
              <path d="M44 28c4 1 7 4 7 8s-3 7-7 8" stroke="var(--amber-dark)" stroke-width="2" stroke-linecap="round"/>
              <path d="M26 16c0-2 1.5-4 4-5M32 15c0-3 2-5 4-6" stroke="var(--text-muted)" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
            </svg>
          </div>
          <h2 class="today-no-beans-title">Start Your Journey</h2>
          <p class="today-no-beans-text">Add a coffee bean to begin tracking your shots and dialing in the perfect espresso.</p>
          <button class="btn btn-amber" @click="currentTab = 'beans'; openBeanForm(null);">
            <span style="font-size: 18px; line-height: 1;">+</span> Add Coffee Bean
          </button>

          <!-- Restore from Archive -->
          <template x-if="archivedBeans.length > 0">
            <div class="restore-from-archive">
              <button x-show="!showArchive" class="restore-toggle" @click="showArchive = true">
                <span class="restore-toggle-icon">&#128230;</span> Or restore from archive
              </button>
              <div x-show="showArchive" x-cloak class="archive-picker">
                <div class="archive-picker-header">
                  <span class="archive-picker-title">Pick a bean to restore</span>
                  <button class="archive-picker-close" @click="showArchive = false">&times;</button>
                </div>
                <div class="archive-picker-list">
                  <template x-for="bean in archivedBeans.slice(0, 5)" :key="bean.id">
                    <button class="archive-picker-item" @click="duplicateFromArchive(bean.id); showArchive = false;">
                      <span class="archive-picker-name" x-text="bean.name"></span>
                      <span class="archive-picker-roaster" x-text="bean.roaster"></span>
                    </button>
                  </template>
                </div>
                <div x-show="archivedBeans.length >= 5" class="archive-picker-footer">
                  <button class="archive-picker-view-all" @click="currentTab = 'beans'; beansView = 'archive'; showArchive = false; document.querySelector('.content-area').scrollTop = 0;">
                    View all <span x-text="archivedBeans.length"></span> archived beans &rarr;
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>

      <!-- Normal Today Tab Content — shown when beans exist -->
      <template x-if="currentBeans.length > 0">
        <div>
          <div class="date-header">
            <div class="day-name" x-text="todayFormatted.day"></div>
            <div class="date-sub" x-text="todayFormatted.date"></div>
          </div>

          <!-- Bean Selector — only current (non-archived) beans -->
          <div class="daily-bean-selector" x-data="{ pickerOpen: false }" @click.outside="pickerOpen = false" @keydown.escape.window="pickerOpen = false">
            <label class="form-label">What are you pulling?</label>
            <div class="bean-picker-trigger" :class="{ open: pickerOpen }" @click="pickerOpen = !pickerOpen" tabindex="0" @keydown.enter.prevent="pickerOpen = !pickerOpen" @keydown.space.prevent="pickerOpen = !pickerOpen" role="combobox" aria-haspopup="listbox" :aria-expanded="pickerOpen">
              <template x-if="!dailySelectedBeanId">
                <span class="picker-placeholder">Choose a coffee bean...</span>
              </template>
              <template x-if="dailySelectedBeanId && getBeanById(dailySelectedBeanId)">
                <span class="picker-selected">
                  <span class="bean-picker-dot" :class="getFreshness(getBeanById(dailySelectedBeanId)).status"></span>
                  <span class="picker-selected-name" x-text="getBeanById(dailySelectedBeanId).name"></span>
                  <span class="picker-selected-roaster" x-text="'\u2014 ' + getBeanById(dailySelectedBeanId).roaster"></span>
                </span>
              </template>
              <svg class="bean-picker-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <div class="bean-picker-dropdown" :class="{ show: pickerOpen }" role="listbox">
              <template x-for="bean in currentBeans" :key="bean.id">
                <div class="bean-picker-option" :class="{ selected: dailySelectedBeanId === bean.id }" @click="dailySelectedBeanId = bean.id; pickerOpen = false; onDailyBeanSelect()" role="option" :aria-selected="dailySelectedBeanId === bean.id" tabindex="0" @keydown.enter.prevent="dailySelectedBeanId = bean.id; pickerOpen = false; onDailyBeanSelect()">
                  <span class="bean-picker-dot" :class="getFreshness(bean).status"></span>
                  <span class="bean-picker-info">
                    <span class="bean-picker-name" x-text="bean.name"></span>
                    <span class="bean-picker-meta">
                      <span x-text="bean.roaster"></span>
                      <span class="bean-picker-freshness" :class="getFreshness(bean).status" x-show="bean.roastDate" x-text="getFreshness(bean).label"></span>
                    </span>
                  </span>
                </div>
              </template>
              <div class="bean-picker-option add-new" @click="pickerOpen = false; openAddBeanFromToday()" role="option" aria-selected="false" tabindex="0" @keydown.enter.prevent="pickerOpen = false; openAddBeanFromToday()">
                <span class="bean-picker-add-icon">+</span>
                <span class="bean-picker-info">
                  <span class="bean-picker-name">Add a new bean</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Today's Shots Summary -->
          <div x-show="todayShots.length > 0" class="mt-24">
            <h3 class="heading-md mb-12">Today's Shots</h3>
            <template x-for="shot in todayShots" :key="shot.id">
              <div class="today-shot-swipe fade-in" x-data="{ swipeStart: 0, swipeX: 0, reveal: false, confirmDelete: false }"
                   @touchstart="swipeStart = $event.touches[0].clientX; swipeX = 0"
                   @touchmove="swipeX = Math.min(0, $event.touches[0].clientX - swipeStart)"
                   @touchend="reveal = swipeX < -36; swipeX = reveal ? -72 : 0"
                   :class="{ 'reveal': reveal }">
                <div class="today-shot-swipe-actions" @click="deleteShot(shot.id)" role="button" tabindex="0" @keydown.enter="deleteShot(shot.id)">Delete</div>
                <div class="today-shot-swipe-content" :style="'transform: translateX(' + (reveal ? -72 : swipeX) + 'px)'">
                  <div class="today-shot-item" style="margin-bottom:0;">
                    <div class="today-shot-content" @click="openShotFormForEdit(shot)">
                      <div class="today-shot-bean" x-text="getBeanById(shot.beanId)?.name || 'Unknown'"></div>
                      <div class="today-shot-details">
                        <span x-show="shot.grindSize" x-text="'Grind ' + shot.grindSize"></span>
                        <span x-show="shot.doseIn"><span x-show="shot.grindSize"> &middot; </span><span x-text="shot.doseIn + 'g'"></span></span>
                        <span x-show="shot.yieldOut"> &#8594; <span x-text="shot.yieldOut + 'g'"></span></span>
                        <span x-show="shot.doseIn && shot.yieldOut"> (<span x-text="'1:' + (shot.yieldOut / shot.doseIn).toFixed(1)"></span>)</span>
                        <span x-show="shot.extractionTime"><span x-show="shot.grindSize || shot.doseIn || shot.yieldOut"> &middot; </span><span x-text="shot.extractionTime + 's'"></span></span>
                      </div>
                      <div x-show="shot.notes" class="text-muted" style="margin-top:2px; font-style:italic; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" x-text="shot.notes"></div>
                      <div x-show="getShotAssessment(shot)" class="shot-assessment" :class="getShotAssessment(shot)?.status" x-text="getShotAssessment(shot)?.label"></div>
                    </div>
                    <div class="today-shot-meta">
                      <span x-show="shotQualityLabel(shot.rating)" class="shot-quality-badge" :class="shotQualityClass(shot.rating)" x-text="shotQualityLabel(shot.rating)"></span>
                      <button x-show="!confirmDelete" type="button" class="btn btn-ghost today-shot-delete" @click.stop="confirmDelete = true" title="Delete shot">&#10005;</button>
                      <button x-show="confirmDelete" type="button" class="btn today-shot-delete-confirm" @click.stop="deleteShot(shot.id)" @click.away="confirmDelete = false" title="Confirm delete">Delete?</button>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <!-- Empty State — has beans but no shots today -->
          <div x-show="todayShots.length === 0 && !dailySelectedBeanId" class="empty-state">
            <div class="empty-state-icon">&#9749;</div>
            <div class="empty-state-title">No shots logged today</div>
            <div class="empty-state-text">Select a bean above to start your morning ritual.</div>
          </div>
        </div>
      </template>
    </div>

    <!-- ═══════════════════════════════════════
         BEANS TAB — Dashboard
         ═══════════════════════════════════════ -->
    <div x-cloak class="tab-pane" :style="tabPaneStyle('beans')">

      <!-- Bean List -->
      <div x-show="beansView === 'list'" class="fade-in">
        <h1 class="heading-xl mb-20">Your Coffee Beans</h1>

        <!-- Current Beans -->
        <div x-show="currentBeans.length > 0">
          <div class="beans-section-label" x-show="archivedBeans.length > 0">Current</div>
          <template x-for="bean in currentBeans" :key="bean.id">
            <div class="bean-card" @click="selectBean(bean.id)">
              <span class="bean-card-occurrence" x-text="getBeanOccurrence(bean)"></span>
              <div class="bean-card-header">
                <div>
                  <div class="bean-card-name" x-text="bean.name"></div>
                  <div class="bean-card-roaster" x-text="bean.roaster"></div>
                </div>
                <span x-show="bean.rating" class="star-display">
                  <template x-for="n in 5">
                    <span class="star" :class="n <= bean.rating ? 'filled' : ''" x-text="n <= bean.rating ? '\u2605' : '\u2606'"></span>
                  </template>
                </span>
              </div>
              <div class="bean-card-roast-date" x-show="bean.roastDate" x-text="formatRoastDate(bean.roastDate)"></div>
              <div class="bean-card-footer">
                <span class="badge" :class="'badge-' + getFreshness(bean).status" x-show="bean.roastDate">
                  <span class="badge-dot"></span>
                  <span x-text="getFreshness(bean).label"></span>
                </span>
              </div>
            </div>
          </template>
        </div>

        <!-- Archived / Old Beans (show first 3, link to full view) -->
        <div x-show="archivedBeans.length > 0">
          <div class="beans-section-header">
            <div class="beans-section-label">Archived</div>
            <button class="beans-section-link" @click="beansView = 'archive'; document.querySelector('.content-area').scrollTop = 0;">View all (<span x-text="archivedBeans.length"></span>)</button>
          </div>
          <template x-for="bean in archivedBeans.slice(0, 3)" :key="bean.id">
            <div class="bean-card archived" @click="selectBean(bean.id)">
              <span class="bean-card-occurrence" x-text="getBeanOccurrence(bean)"></span>
              <div class="bean-card-header">
                <div>
                  <div class="bean-card-name" x-text="bean.name"></div>
                  <div class="bean-card-roaster" x-text="bean.roaster"></div>
                </div>
                <span x-show="bean.rating" class="star-display">
                  <template x-for="n in 5">
                    <span class="star" :class="n <= bean.rating ? 'filled' : ''" x-text="n <= bean.rating ? '\u2605' : '\u2606'"></span>
                  </template>
                </span>
              </div>
              <div class="bean-card-roast-date" x-show="bean.roastDate" x-text="formatRoastDate(bean.roastDate)"></div>
              <div class="bean-card-footer">
                <span class="badge badge-archived"><span class="badge-dot"></span><span>Archived</span></span>
              </div>
            </div>
          </template>
        </div>

        <!-- Empty State -->
        <div x-show="beans.length === 0" class="empty-state">
          <div class="empty-state-icon">&#127793;</div>
          <div class="empty-state-title">Add your first bean</div>
          <div class="empty-state-text">Start tracking your espresso beans and dial in the perfect shot.</div>
          <button class="btn btn-amber" @click="openBeanForm(null)">Add Bean</button>
        </div>

        <!-- Freshness Legend -->
        <div x-show="beans.length > 0" class="freshness-legend">
          <div class="beans-section-label">Freshness Stages</div>
          <div class="freshness-legend-items">
          <div class="freshness-legend-item">
            <span class="freshness-legend-dot resting"></span>
            <div class="freshness-legend-text">
              <span class="freshness-legend-label">Resting</span>
              <span class="freshness-legend-days">0–6 days post-roast</span>
              <span class="freshness-legend-desc">Extraction can be gassy and less consistent.</span>
            </div>
          </div>
          <div class="freshness-legend-item">
            <span class="freshness-legend-dot at-peak"></span>
            <div class="freshness-legend-text">
              <span class="freshness-legend-label">At Peak</span>
              <span class="freshness-legend-days">7–21 days post-roast</span>
              <span class="freshness-legend-desc">Best balance of stable extraction and vibrant flavor.</span>
            </div>
          </div>
          <div class="freshness-legend-item">
            <span class="freshness-legend-dot past-peak"></span>
            <div class="freshness-legend-text">
              <span class="freshness-legend-label">Past Peak</span>
              <span class="freshness-legend-days">22+ days post-roast</span>
              <span class="freshness-legend-desc">Flavor and aromatics may fade. Still brewable, but expect less pop.</span>
            </div>
          </div>
          </div>
        </div>
      </div>

      <!-- Bean Detail -->
      <div x-show="beansView === 'detail' && selectedBean" class="fade-in">
        <div class="detail-header">
          <button class="back-btn" @click="beansView = 'list'; selectedBeanId = null; document.querySelector('.content-area').scrollTop = 0;">&#8592;</button>
          <div style="flex:1;">
            <h2 class="heading-lg" x-text="selectedBean?.name"></h2>
            <div class="text-secondary" x-text="selectedBean?.roaster"></div>
            <span x-show="selectedBean?.isArchived" class="badge badge-archived" style="margin-top: 4px;">Archived</span>
          </div>
          <button class="btn-duplicate" @click="duplicateBean(selectedBeanId)" title="Duplicate bean">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
          <button x-show="!selectedBean?.isArchived" class="btn btn-ghost" style="padding: 8px 12px; font-size: 14px;" @click="openBeanForm(selectedBeanId)">Edit</button>
        </div>

        <!-- Days remaining (roast date is edited only in Edit Bean screen) -->
        <div x-show="selectedBean?.roastDate" class="freshness-display mb-16" :class="getFreshness(selectedBean).status">
          <span class="freshness-icon"></span>
          <span class="freshness-text" x-text="getFreshness(selectedBean).detail"></span>
        </div>

        <!-- Optimal Settings (always visible; set or change via Edit) -->
        <div class="recipe-card">
          <div class="recipe-card-label">Best dial-in</div>
          <div class="text-secondary" style="font-size: 12px; margin-top: 2px; margin-bottom: 10px;">The best dial-in you’ve achieved for this coffee so far. Adjust as the coffee ages.</div>
          <div x-show="editingOptimalBeanId !== selectedBeanId">
            <div class="recipe-card-grid">
              <div>
                <div class="recipe-stat-label">Grind</div>
                <div class="recipe-stat-value" x-text="selectedBean?.optimalGrindSize ?? '\u2014'"></div>
              </div>
              <div>
                <div class="recipe-stat-label">Dose</div>
                <div class="recipe-stat-value" x-text="selectedBean?.optimalDoseIn != null ? selectedBean.optimalDoseIn + 'g' : '\u2014'"></div>
              </div>
              <div>
                <div class="recipe-stat-label">Yield</div>
                <div class="recipe-stat-value" x-text="selectedBean?.optimalYieldOut != null ? selectedBean.optimalYieldOut + 'g' : '\u2014'"></div>
              </div>
              <div>
                <div class="recipe-stat-label">Time</div>
                <div class="recipe-stat-value" x-text="selectedBean?.optimalExtractionTime != null ? selectedBean.optimalExtractionTime + 's' : '\u2014'"></div>
              </div>
            </div>
            <div x-show="selectedBean?.optimalDoseIn && selectedBean?.optimalYieldOut" style="margin-top:10px;">
              <span class="recipe-stat-label">Ratio</span>
              <span class="recipe-stat-value" style="font-size:16px; margin-left: 6px;" x-text="'1:' + (selectedBean.optimalYieldOut / selectedBean.optimalDoseIn).toFixed(1)"></span>
            </div>
            <button x-show="!selectedBean?.isArchived" type="button" class="btn btn-ghost recipe-card-edit" @click="startEditingOptimal()">Edit</button>
          </div>
          <div x-show="editingOptimalBeanId === selectedBeanId" class="recipe-card-edit-form">
            <div x-data="optimalStepper()" x-init="stInit('grindSize', 1, 10, selectedBean?.optimalGrindSize ?? 5)">
              <div class="recipe-stat-label">Grind</div>
              <div class="stepper stepper-dark">
                <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
                <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
                <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
              <div x-data="optimalStepper()" x-init="stInit('doseIn', 1, 50, selectedBean?.optimalDoseIn ?? 18)">
                <div class="recipe-stat-label">Dose (g)</div>
                <div class="stepper stepper-dark">
                  <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
                  <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
                  <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
                </div>
              </div>
              <div x-data="optimalStepper()" x-init="stInit('yieldOut', 1, 100, selectedBean?.optimalYieldOut ?? 36)">
                <div class="recipe-stat-label">Yield (g)</div>
                <div class="stepper stepper-dark">
                  <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
                  <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
                  <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
                </div>
              </div>
            </div>
            <div style="margin-top: 12px;" x-data="optimalStepper()" x-init="stInit('extractionTime', 1, 60, selectedBean?.optimalExtractionTime ?? 25)">
              <div class="recipe-stat-label">Extraction Time (s)</div>
              <div class="stepper stepper-dark">
                <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
                <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
                <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 12px;">
              <button type="button" class="btn btn-cancel" @click="cancelEditingOptimal()">Cancel</button>
              <button type="button" class="btn btn-amber" @click="saveOptimalSettings()">Save</button>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div x-show="selectedBean?.notes" class="mb-16">
          <p class="text-secondary" style="font-style: italic;" x-text="selectedBean?.notes"></p>
        </div>

        <!-- Shot History -->
        <div class="mb-20" x-data="{ showAllShots: false }">
          <div style="display: flex; align-items: center; justify-content: space-between;" class="mb-12">
            <h3 class="heading-md">Shot History</h3>
            <button x-show="!selectedBean?.isArchived" class="btn btn-amber" style="padding: 8px 16px; font-size: 14px;" @click="openShotFormFromBean()">+ Log Shot</button>
          </div>

          <div x-show="getShotsForBean(selectedBeanId).length === 0" class="empty-state" style="padding: 24px;">
            <div class="empty-state-icon" style="font-size: 32px;">&#9749;</div>
            <div class="empty-state-text">Log your first shot to start dialing in.</div>
          </div>
          <template x-for="shot in (showAllShots ? getShotsForBean(selectedBeanId) : getShotsForBean(selectedBeanId).slice(0, 5))" :key="shot.id">
            <div class="today-shot-swipe fade-in" x-data="{ swipeStart: 0, swipeX: 0, reveal: false, confirmDelete: false }"
                 @touchstart="if (!selectedBean?.isArchived) { swipeStart = $event.touches[0].clientX; swipeX = 0; }"
                 @touchmove="if (!selectedBean?.isArchived) { swipeX = Math.min(0, $event.touches[0].clientX - swipeStart); }"
                 @touchend="if (!selectedBean?.isArchived) { reveal = swipeX < -36; swipeX = reveal ? -72 : 0; }"
                 :class="{ 'reveal': reveal }">
              <div class="today-shot-swipe-actions" @click="deleteShot(shot.id)" role="button" tabindex="0" @keydown.enter="deleteShot(shot.id)">Delete</div>
              <div class="today-shot-swipe-content today-shot-content" :style="'transform: translateX(' + (reveal ? -72 : swipeX) + 'px)'" @click="if (!selectedBean?.isArchived) openShotFormForEdit(shot)">
                <div class="shot-row bean-shot-swipe-row">
                  <div class="shot-info">
                    <div class="shot-settings">
                      <span x-show="shot.grindSize">Grind <span x-text="shot.grindSize"></span></span>
                      <span x-show="shot.doseIn"><span x-show="shot.grindSize"> &middot; </span><span x-text="shot.doseIn + 'g'"></span></span>
                      <span x-show="shot.yieldOut"> &#8594; <span x-text="shot.yieldOut + 'g'"></span></span>
                      <span x-show="shot.doseIn && shot.yieldOut"> (<span x-text="'1:' + (shot.yieldOut / shot.doseIn).toFixed(1)"></span>)</span>
                      <span x-show="shot.extractionTime"><span x-show="shot.grindSize || shot.doseIn || shot.yieldOut"> &middot; </span><span x-text="shot.extractionTime + 's'"></span></span>
                    </div>
                    <div class="shot-date" x-text="formatDate(shot.shotDate || shot.createdAt)"></div>
                    <div x-show="shot.notes" class="text-muted" style="margin-top:2px; font-style:italic; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" x-text="shot.notes"></div>
                    <div x-show="getShotAssessment(shot)" class="shot-assessment" :class="getShotAssessment(shot)?.status" x-text="getShotAssessment(shot)?.label"></div>
                  </div>
                  <div class="shot-meta">
                    <span x-show="shotQualityLabel(shot.rating)" class="shot-quality-badge" :class="shotQualityClass(shot.rating)" x-text="shotQualityLabel(shot.rating)"></span>
                    <button x-show="!selectedBean?.isArchived && !confirmDelete" type="button" class="btn btn-ghost today-shot-delete" @click.stop="confirmDelete = true" title="Delete shot">&#10005;</button>
                    <button x-show="!selectedBean?.isArchived && confirmDelete" type="button" class="btn today-shot-delete-confirm" @click.stop="deleteShot(shot.id)" @click.away="confirmDelete = false" title="Confirm delete">Delete?</button>
                  </div>
                </div>
              </div>
            </div>
          </template>
          <button x-show="!showAllShots && getShotsForBean(selectedBeanId).length > 5" class="beans-section-link" style="display: block; margin-top: 8px; width: 100%; text-align: center;" @click="showAllShots = true">View all</button>
        </div>

        <!-- Rating (editable only here, not on Edit Bean form) -->
        <div class="bean-detail-stars mb-16">
          <div class="text-secondary" style="font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Rating</div>
          <div class="star-rating">
            <template x-for="n in 5">
              <span class="star" :class="n <= (selectedBean?.rating || 0) ? 'filled' : ''"
                    x-text="n <= (selectedBean?.rating || 0) ? '\u2605' : '\u2606'"
                    @click="if (!selectedBean?.isArchived) updateBeanRating(n)"
                    :style="selectedBean?.isArchived ? 'cursor: default;' : ''"></span>
            </template>
          </div>
        </div>

        <div class="divider"></div>
        <button x-show="selectedBean && !selectedBean.isArchived" class="btn btn-ghost btn-archive-highlight btn-full mb-8" @click="archiveBean(selectedBeanId)">Archive Bean</button>
        <button x-show="selectedBean && selectedBean.isArchived" class="btn btn-amber btn-full mb-8" @click="unarchiveBean(selectedBeanId)">Bring Back Bean</button>
        <button class="btn btn-danger btn-delete-highlight btn-full" @click="openDeleteBeanDialog()">Delete Bean</button>
      </div>

      <!-- Archive View — Full list of archived beans -->
      <div x-show="beansView === 'archive'" class="fade-in">
        <div class="archive-view-header">
          <button class="back-btn" @click="beansView = 'list'; document.querySelector('.content-area').scrollTop = 0;">&#8592;</button>
          <div class="archive-view-title">
            <h2 class="heading-lg">Archived Beans</h2>
            <p class="text-muted" style="margin-top: 2px;"><span x-text="archivedBeans.length"></span> beans in archive</p>
          </div>
        </div>

        <div x-show="archivedBeans.length === 0" class="empty-state">
          <div class="empty-state-icon">&#128230;</div>
          <div class="empty-state-title">No archived beans</div>
          <div class="empty-state-text">Beans you've finished will appear here.</div>
        </div>

        <template x-for="bean in archivedBeans" :key="bean.id">
          <div class="bean-card archived" @click="selectBean(bean.id)">
            <span class="bean-card-occurrence" x-text="getBeanOccurrence(bean)"></span>
            <div class="bean-card-header">
              <div>
                <div class="bean-card-name" x-text="bean.name"></div>
                <div class="bean-card-roaster" x-text="bean.roaster"></div>
              </div>
              <span x-show="bean.rating" class="star-display">
                <template x-for="n in 5">
                  <span class="star" :class="n <= bean.rating ? 'filled' : ''" x-text="n <= bean.rating ? '\u2605' : '\u2606'"></span>
                </template>
              </span>
            </div>
            <div class="bean-card-roast-date" x-show="bean.roastDate" x-text="formatRoastDate(bean.roastDate)"></div>
            <div class="bean-card-footer">
              <span class="badge badge-archived"><span class="badge-dot"></span><span>Archived</span></span>
            </div>
          </div>
        </template>
      </div>

      <!-- Add/Edit Bean Form -->
      <div x-show="beansView === 'form'" class="fade-in" x-data="{ showBeanPicker: false }">
        <div class="detail-header">
          <button class="back-btn" @click="cancelBeanForm()">&#8592;</button>
          <h2 class="heading-lg" x-text="editingBeanId ? 'Edit Bean' : 'Add Bean'"></h2>
        </div>

        <!-- Fill from previous — only shown when adding, not editing -->
        <div x-show="!editingBeanId && !_pendingDuplicateBean && getUniqueBeanSources().length > 0" class="fill-from-previous mb-16" @click.outside="showBeanPicker = false">
          <button type="button" class="fill-from-previous-trigger" @click="showBeanPicker = !showBeanPicker">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>Fill from previous bean</span>
          </button>
          <div x-show="showBeanPicker" x-cloak class="fill-from-previous-picker">
            <div class="archive-picker-header">
              <span class="archive-picker-title">Pick a bean to copy</span>
              <button class="archive-picker-close" @click="showBeanPicker = false">&times;</button>
            </div>
            <div class="archive-picker-list">
              <template x-for="bean in getUniqueBeanSources()" :key="bean.id">
                <button class="archive-picker-item" @click="duplicateBean(bean.id); showBeanPicker = false;">
                  <span class="archive-picker-name" x-text="bean.name"></span>
                  <span class="archive-picker-roaster" x-text="bean.roaster"></span>
                </button>
              </template>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Bean Name <span class="required">*</span></label>
          <input type="text" class="form-input" placeholder="e.g. Unicorn Blood" x-model="beanForm.name">
        </div>
        <div class="form-group">
          <label class="form-label">Roaster <span class="required">*</span></label>
          <input type="text" class="form-input" placeholder="e.g. Dark Matter" x-model="beanForm.roaster">
        </div>
        <div class="form-group date-picker-group" x-data="datePicker()" x-init="dpInit('beanForm.roastDate')">
          <label class="form-label">Roast Date</label>
          <div class="date-input-wrapper" x-ref="dateInputWrapper" @click="dpToggle()">
            <input type="text" class="form-input" :value="dpDisplayValue()" placeholder="Select date" readonly>
            <span class="date-input-actions">
              <button type="button" class="date-clear-btn" x-show="dpValue()" @click.stop="dpClear()" title="Clear date">&times;</button>
            </span>
          </div>
          <template x-if="dpOpen">
            <div class="custom-datepicker" x-ref="datepickerEl" @click.stop>
              <div class="datepicker-nav">
                <div class="datepicker-month-year" x-text="dpMonthYearLabel()"></div>
                <div class="datepicker-nav-actions">
                  <button type="button" class="datepicker-today-btn" @click="dpGoToday()">Today</button>
                  <button type="button" class="datepicker-nav-btn" @click="dpPrevMonth()" aria-label="Previous month">&lsaquo;</button>
                  <button type="button" class="datepicker-nav-btn" @click="dpNextMonth()" aria-label="Next month">&rsaquo;</button>
                </div>
              </div>
              <div class="datepicker-weekdays">
                <template x-for="d in ['Su','Mo','Tu','We','Th','Fr','Sa']">
                  <div class="datepicker-weekday" x-text="d"></div>
                </template>
              </div>
              <div class="datepicker-days">
                <template x-for="day in dpDays()" :key="day.key">
                  <button type="button" class="datepicker-day"
                    :class="{ outside: day.outside, today: day.isToday, selected: day.isSelected }"
                    @click.stop="!day.outside && dpSelect(day.date)"
                    x-text="day.day"></button>
                </template>
              </div>
              <div class="datepicker-footer">
                <button type="button" class="datepicker-clear-btn" x-show="dpValue()" @click="dpClear()">Clear</button>
              </div>
            </div>
          </template>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-input" placeholder="Tasting notes, brew tips..." x-model="beanForm.notes"></textarea>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" style="flex: 1;" @click="saveBean()">Save</button>
        </div>
      </div>

      <!-- FAB: Add Bean -->
      <button x-show="currentTab === 'beans' && beansView === 'list' && beans.length > 0" class="fab" @click="openBeanForm(null)"><span class="fab-icon">+</span> Add Bean</button>
    </div>

    <!-- ═══════════════════════════════════════
         CALENDAR TAB
         ═══════════════════════════════════════ -->
    <div x-cloak class="tab-pane" :style="tabPaneStyle('calendar')">
      <h1 class="heading-xl mb-12">Roast Freshness Calendar</h1>
      <p class="calendar-description">See when each coffee is at peak freshness this month.</p>
      <div class="calendar-card">
        <div class="calendar-header">
          <button class="calendar-nav" @click="prevMonth()" aria-label="Previous month">&#8592;</button>
          <span class="calendar-month-label" x-text="calendarMonthLabel"></span>
          <button class="calendar-nav" @click="nextMonth()" aria-label="Next month">&#8594;</button>
        </div>
        <div class="calendar-weekdays">
          <template x-for="d in ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']">
            <div class="calendar-weekday" x-text="d"></div>
          </template>
        </div>
        <div class="calendar-grid">
          <template x-for="(week, wi) in calendarWeeks" :key="calendarYear + '-' + calendarMonth + '-' + wi">
            <div class="calendar-row">
              <div class="calendar-range-bands">
                <template x-for="(bar, bi) in calendarBarsForWeek(wi)" :key="bar.beanId + '-' + calendarYear + '-' + calendarMonth + '-' + wi">
                  <div class="calendar-range-band" :style="getRangeBandStyle(bar, wi)"></div>
                </template>
              </div>
              <template x-for="(day, di) in week" :key="calendarYear + '-' + calendarMonth + '-' + wi + '-' + di">
                <div class="calendar-cell" :class="{ 'empty': !day, 'today': day && isToday(calendarYear, calendarMonth, day) }">
                  <span x-text="day || ''"></span>
                </div>
              </template>
            </div>
          </template>
        </div>
        <div x-show="calendarBars.length > 0" class="calendar-legend">
          <template x-for="bar in calendarBarsUnique" :key="bar.beanId">
            <button
              type="button"
              class="legend-item"
              :class="{ 'dimmed': calendarFilteredBeanIds.length > 0 && !calendarFilteredBeanIds.includes(bar.beanId) }"
              :aria-pressed="calendarFilteredBeanIds.includes(bar.beanId)"
              @click="toggleCalendarFilter(bar.beanId)"
            >
              <div class="legend-dot" :style="'background:' + bar.color"></div>
              <span x-text="bar.beanName"></span>
            </button>
          </template>
        </div>
        <div x-show="calendarBars.length === 0" class="empty-state calendar-empty-state" style="padding: 32px 0 8px;">
          <div class="empty-state-icon">&#128197;</div>
          <div class="empty-state-title">No beans in window</div>
          <div class="empty-state-text">No beans have their peak freshness window this month.</div>
        </div>
        <p class="calendar-note">Peak freshness window: ~7–21 days post-roast, when off-gassing has settled and flavors are at their best.</p>
      </div>
    </div>

    </div>

  </div>

  <!-- ═══════════════════════════════════════
       SHOT FORM OVERLAY
       ═══════════════════════════════════════ -->
  <template x-if="showShotForm">
  <div class="overlay" @click.self="closeShotForm()">
    <div class="panel" @click.stop>
      <div style="display: flex; align-items: center; gap: 12px;" class="mb-20">
        <button class="back-btn" @click="closeShotForm()">&#8592;</button>
        <h3 class="heading-lg" x-text="editingShotId ? 'Edit Shot' : 'Log Shot'"></h3>
      </div>
      <div class="form-group" x-data="stepper()" x-init="stInit('grindSize', 1, 30, getShotFormDefault('grindSize'))">
        <label class="form-label">Grind Size</label>
        <div class="stepper">
          <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
          <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
          <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div class="form-group" x-data="stepper()" x-init="stInit('doseIn', 1, 50, getShotFormDefault('doseIn'))">
          <label class="form-label">Dose In (g)</label>
          <div class="stepper">
            <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
            <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
            <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
          </div>
        </div>
        <div class="form-group" x-data="stepper()" x-init="stInit('yieldOut', 1, 100, getShotFormDefault('yieldOut'))">
          <label class="form-label">Yield Out (g)</label>
          <div class="stepper">
            <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
            <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
            <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
          </div>
        </div>
      </div>
      <div class="form-group" x-data="stepper()" x-init="stInit('extractionTime', 1, 60, getShotFormDefault('extractionTime'))">
        <label class="form-label">Extraction Time (s)</label>
        <div class="stepper">
          <button type="button" class="stepper-btn" aria-label="Decrease" :disabled="stVal() !== null && stVal() <= stMin" @click="stDec()">−</button>
          <input type="number" inputmode="numeric" class="stepper-input" :min="stMin" :max="stMax" :placeholder="stPlaceholder()" :value="stVal() === null ? '' : stVal()" @input="stOnInput($event)" @focus="stOnFocus($event)">
          <button type="button" class="stepper-btn" aria-label="Increase" :disabled="stVal() !== null && stVal() >= stMax" @click="stInc()">+</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">How was this shot?</label>
        <div class="shot-rating-row">
          <div class="shot-quality-options">
            <button type="button" class="shot-quality-btn bad" :class="{ 'active': shotForm.rating === 'bad' }" @click="shotForm.rating = (shotForm.rating === 'bad' ? null : 'bad')">Bad</button>
            <button type="button" class="shot-quality-btn okay" :class="{ 'active': shotForm.rating === 'okay' }" @click="shotForm.rating = (shotForm.rating === 'okay' ? null : 'okay')">Okay</button>
            <button type="button" class="shot-quality-btn great" :class="{ 'active': shotForm.rating === 'great' }" @click="shotForm.rating = (shotForm.rating === 'great' ? null : 'great')">Great</button>
            <button type="button" class="shot-quality-btn perfect" :class="{ 'active': shotForm.rating === 'perfect' }" @click="shotForm.rating = (shotForm.rating === 'perfect' ? null : 'perfect')">Perfect</button>
          </div>
          <div class="shot-date-picker date-picker-group" x-data="datePicker()" x-init="dpInit('shotForm.shotDate')">
            <div class="date-input-wrapper" x-ref="dateInputWrapper" @click="dpToggle()">
              <input type="text" class="form-input" :value="dpDisplayValue()" placeholder="Date" readonly>
              <span class="date-input-actions">
                <button type="button" class="date-clear-btn" x-show="dpValue()" @click.stop="dpClear()" title="Clear date">&times;</button>
              </span>
            </div>
            <template x-if="dpOpen">
              <div class="custom-datepicker" x-ref="datepickerEl" @click.stop>
                <div class="datepicker-nav">
                  <div class="datepicker-month-year" x-text="dpMonthYearLabel()"></div>
                  <div class="datepicker-nav-actions">
                    <button type="button" class="datepicker-today-btn" @click="dpGoToday()">Today</button>
                    <button type="button" class="datepicker-nav-btn" @click="dpPrevMonth()" aria-label="Previous month">&lsaquo;</button>
                    <button type="button" class="datepicker-nav-btn" @click="dpNextMonth()" aria-label="Next month">&rsaquo;</button>
                  </div>
                </div>
                <div class="datepicker-weekdays">
                  <template x-for="d in ['Su','Mo','Tu','We','Th','Fr','Sa']">
                    <div class="datepicker-weekday" x-text="d"></div>
                  </template>
                </div>
                <div class="datepicker-days">
                  <template x-for="day in dpDays()" :key="day.key">
                    <button type="button" class="datepicker-day"
                      :class="{ outside: day.outside, today: day.isToday, selected: day.isSelected }"
                      @click.stop="!day.outside && dpSelect(day.date)"
                      x-text="day.day"></button>
                  </template>
                </div>
                <div class="datepicker-footer">
                  <button type="button" class="datepicker-clear-btn" x-show="dpValue()" @click="dpClear()">Clear</button>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-input" placeholder="How did it taste?" x-model="shotForm.notes" rows="2" style="resize:none;"></textarea>
      </div>
      <label class="best-dialin-toggle">
        <input type="checkbox" x-model="shotForm.saveAsBestDialIn" @change="if (shotForm.saveAsBestDialIn) $nextTick(() => $el.closest('.panel')?.querySelector('.best-dialin-comparison')?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }))">
        <span>Save as best dial-in</span>
      </label>
      <template x-if="shotForm.saveAsBestDialIn">
        <div class="best-dialin-comparison fade-in" x-data="{ get comp() { return getShotFormBestDialInComparison() } }">
          <template x-if="comp.allSame">
            <div class="best-dialin-same">Same as current best dial-in</div>
          </template>
          <template x-if="!comp.allSame">
            <div>
              <div class="best-dialin-comparison-title">Update Best Dial-In</div>
              <table class="best-dialin-comparison-table">
                <thead><tr><th></th><th>Current</th><th>New</th></tr></thead>
                <tbody>
                  <tr><td>Grind</td><td x-text="comp.current.grindSize ?? '—'"></td><td x-text="comp.next.grindSize ?? '—'"></td></tr>
                  <tr><td>Dose</td><td x-text="comp.current.doseIn != null ? comp.current.doseIn + 'g' : '—'"></td><td x-text="comp.next.doseIn != null ? comp.next.doseIn + 'g' : '—'"></td></tr>
                  <tr><td>Yield</td><td x-text="comp.current.yieldOut != null ? comp.current.yieldOut + 'g' : '—'"></td><td x-text="comp.next.yieldOut != null ? comp.next.yieldOut + 'g' : '—'"></td></tr>
                  <tr><td>Time</td><td x-text="comp.current.extractionTime != null ? comp.current.extractionTime + 's' : '—'"></td><td x-text="comp.next.extractionTime != null ? comp.next.extractionTime + 's' : '—'"></td></tr>
                </tbody>
              </table>
            </div>
          </template>
        </div>
      </template>
      <div class="form-actions">
        <button class="btn btn-primary" style="flex: 1;" @click="saveShot()">Save Shot</button>
      </div>
    </div>
  </div>
  </template>

  <!-- ═══════════════════════════════════════
       ADD BEAN MODAL (FROM TODAY PICKER)
       ═══════════════════════════════════════ -->
  <template x-if="showBeanFormModal">
  <div class="overlay" @click.self="cancelBeanForm()">
    <div class="panel" @click.stop x-data="{ showBeanPicker: false }">
      <div style="display: flex; align-items: center; gap: 12px;" class="mb-20">
        <button class="back-btn" @click="cancelBeanForm()">&#8592;</button>
        <h3 class="heading-lg">Add Bean</h3>
      </div>
      <!-- Fill from previous (archived beans only) -->
      <div x-show="!_pendingDuplicateBean && getUniqueBeanSources({ archivedOnly: true }).length > 0" class="fill-from-previous mb-16" @click.outside="showBeanPicker = false">
        <button type="button" class="fill-from-previous-trigger" @click="showBeanPicker = !showBeanPicker">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          <span>Fill from previous bean</span>
        </button>
        <div x-show="showBeanPicker" x-cloak class="fill-from-previous-picker">
          <div class="archive-picker-header">
            <span class="archive-picker-title">Pick a bean to copy</span>
            <button class="archive-picker-close" @click="showBeanPicker = false">&times;</button>
          </div>
          <div class="archive-picker-list">
            <template x-for="bean in getUniqueBeanSources({ archivedOnly: true })" :key="bean.id">
              <button class="archive-picker-item" @click="fillBeanFormFrom(bean.id); showBeanPicker = false;">
                <span class="archive-picker-name" x-text="bean.name"></span>
                <span class="archive-picker-roaster" x-text="bean.roaster"></span>
              </button>
            </template>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Bean Name <span class="required">*</span></label>
        <input type="text" class="form-input" placeholder="e.g. Unicorn Blood" x-model="beanForm.name">
      </div>
      <div class="form-group">
        <label class="form-label">Roaster <span class="required">*</span></label>
        <input type="text" class="form-input" placeholder="e.g. Dark Matter" x-model="beanForm.roaster">
      </div>
      <div class="form-group date-picker-group" x-data="datePicker()" x-init="dpInit('beanForm.roastDate')">
        <label class="form-label">Roast Date</label>
        <div class="date-input-wrapper" x-ref="dateInputWrapper" @click="dpToggle()">
          <input type="text" class="form-input" :value="dpDisplayValue()" placeholder="Select date" readonly>
          <span class="date-input-actions">
            <button type="button" class="date-clear-btn" x-show="dpValue()" @click.stop="dpClear()" title="Clear date">&times;</button>
          </span>
        </div>
        <template x-if="dpOpen">
          <div class="custom-datepicker" x-ref="datepickerEl" @click.stop>
            <div class="datepicker-nav">
              <div class="datepicker-month-year" x-text="dpMonthYearLabel()"></div>
              <div class="datepicker-nav-actions">
                <button type="button" class="datepicker-today-btn" @click="dpGoToday()">Today</button>
                <button type="button" class="datepicker-nav-btn" @click="dpPrevMonth()" aria-label="Previous month">&lsaquo;</button>
                <button type="button" class="datepicker-nav-btn" @click="dpNextMonth()" aria-label="Next month">&rsaquo;</button>
              </div>
            </div>
            <div class="datepicker-weekdays">
              <template x-for="d in ['Su','Mo','Tu','We','Th','Fr','Sa']">
                <div class="datepicker-weekday" x-text="d"></div>
              </template>
            </div>
            <div class="datepicker-days">
              <template x-for="day in dpDays()" :key="day.key">
                <button type="button" class="datepicker-day"
                  :class="{ outside: day.outside, today: day.isToday, selected: day.isSelected }"
                  @click.stop="!day.outside && dpSelect(day.date)"
                  x-text="day.day"></button>
              </template>
            </div>
            <div class="datepicker-footer">
              <button type="button" class="datepicker-clear-btn" x-show="dpValue()" @click="dpClear()">Clear</button>
            </div>
          </div>
        </template>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-input" placeholder="Tasting notes, brew tips..." x-model="beanForm.notes"></textarea>
      </div>
      <div x-show="beanFormError" class="mb-12" style="color: var(--freshness-past); font-size: 13px;" x-text="beanFormError"></div>
      <div class="form-actions">
        <button class="btn btn-primary" style="flex: 1;" @click="saveBean()">Save</button>
      </div>
    </div>
  </div>
  </template>

  <template x-if="showBackupPanel">
  <div class="overlay" @click.self="closeBackupPanel()" @keydown.escape.window="closeBackupPanel()">
    <div class="panel" @click.stop>
      <div style="display: flex; align-items: center; gap: 12px;" class="mb-20">
        <button class="back-btn" @click="closeBackupPanel()">&#8592;</button>
        <h3 class="heading-lg">Backup & Restore</h3>
      </div>
      <p class="backup-description">Export a backup file and import it on any device or browser to carry your coffee history with you.</p>

      <div class="backup-card">
        <div class="backup-card-title">Backup Status</div>
        <div class="backup-status-grid">
          <div class="backup-status-item">
            <div class="backup-status-label">Last Export</div>
            <div class="backup-status-value" x-text="backupLastExportedAt ? formatDateTime(backupLastExportedAt) : 'Not yet exported'"></div>
          </div>
          <div class="backup-status-item">
            <div class="backup-status-label">Last Import</div>
            <div class="backup-status-value" x-text="backupLastImportedAt ? formatDateTime(backupLastImportedAt) : 'No import yet'"></div>
          </div>
        </div>
        <div class="backup-actions">
          <button class="btn btn-amber" @click="exportBackup()">Export Backup</button>
          <button class="btn btn-secondary-solid" @click="triggerBackupImport()">Choose Backup File</button>
          <input x-ref="backupImportInput" class="backup-import-input" type="file" accept="application/json,.json" @change="onBackupFileSelected($event)">
        </div>
        <p class="backup-help">Safe merge: existing entries stay unchanged, only new entries are added.</p>
        <div x-show="backupNoticeMessage" class="backup-alert" :class="backupNoticeType" x-text="backupNoticeMessage"></div>

        <div x-show="backupImportPreview" class="backup-preview">
          <div class="backup-preview-title" x-text="'Ready to import from ' + backupImportPreview.fileName"></div>
          <div class="backup-preview-grid">
            <div class="backup-preview-kv">
              <div class="backup-preview-kv-label">New Beans</div>
              <div class="backup-preview-kv-value" x-text="backupImportPreview.newBeans"></div>
            </div>
            <div class="backup-preview-kv">
              <div class="backup-preview-kv-label">New Shots</div>
              <div class="backup-preview-kv-value" x-text="backupImportPreview.newShots"></div>
            </div>
            <div class="backup-preview-kv">
              <div class="backup-preview-kv-label">Skipped Existing</div>
              <div class="backup-preview-kv-value" x-text="backupImportPreview.skippedExisting"></div>
            </div>
            <div class="backup-preview-kv">
              <div class="backup-preview-kv-label">Invalid/Skipped</div>
              <div class="backup-preview-kv-value" x-text="backupImportPreview.invalidOrSkipped"></div>
            </div>
          </div>
          <div class="backup-preview-actions">
            <button class="btn btn-primary" @click="confirmBackupImport()">Import Backup</button>
            <button class="btn btn-ghost" @click="clearBackupImportPreview()">Cancel</button>
          </div>
        </div>
      </div>

      <div class="backup-card">
        <div class="backup-card-title">Quick Steps</div>
        <div class="backup-steps-heading">Back Up (2 steps)</div>
        <div class="backup-howto-grid">
          <div class="backup-step">
            <div class="backup-step-head">
              <span class="backup-step-num">1</span>
              <span class="backup-step-title">Tap “Export Backup”</span>
            </div>
            <p class="backup-step-copy">A file like `coffee-journal-backup-YYYY-MM-DD.json` should download to your device.p>
          </div>
          <div class="backup-step">
            <div class="backup-step-head">
              <span class="backup-step-num">2</span>
              <span class="backup-step-title">Save the file</span>
            </div>
            <p class="backup-step-copy">Save the file to your preferred location (iCloud, Downloads folder).</p>
          </div>
        </div>
        <div class="backup-steps-heading">Restore (3 steps)</div>
        <div class="backup-howto-grid">
          <div class="backup-step">
            <div class="backup-step-head">
              <span class="backup-step-num">1</span>
              <span class="backup-step-title">Tap “Choose Backup File”</span>
            </div>
            <p class="backup-step-copy">Navigate to where you saved the `.json` backup file and select it.</p>
          </div>
          <div class="backup-step">
            <div class="backup-step-head">
              <span class="backup-step-num">2</span>
              <span class="backup-step-title">Check the preview</span>
            </div>
            <p class="backup-step-copy">Confirm the “New Beans” and “New Shots” counts before importing.</p>
          </div>
          <div class="backup-step">
            <div class="backup-step-head">
              <span class="backup-step-num">3</span>
              <span class="backup-step-title">Tap “Import Backup”</span>
            </div>
            <p class="backup-step-copy">Only new data is added. Existing entries are not overwritten.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  </template>

  <template x-if="showDeleteBeanDialog">
  <div class="overlay" @click.self="closeDeleteBeanDialog()" @keydown.escape.window="closeDeleteBeanDialog()">
    <div class="panel delete-confirm-panel" @click.stop role="dialog" aria-modal="true" aria-labelledby="delete-bean-title">
      <div class="delete-confirm-icon" aria-hidden="true">&#9888;</div>
      <h3 id="delete-bean-title" class="heading-lg delete-confirm-title">Delete Bean?</h3>
      <p class="delete-confirm-copy">
        This will permanently delete <strong x-text="selectedBean?.name || 'this bean'"></strong> and
        <strong><span x-text="getShotsForBean(selectedBeanId).length"></span> <span x-text="getShotsForBean(selectedBeanId).length === 1 ? 'shot' : 'shots'"></span></strong>.
        This cannot be undone.
      </p>
      <div class="delete-confirm-actions">
        <button type="button" class="btn btn-secondary-solid" @click="closeDeleteBeanDialog()">Cancel</button>
        <button type="button" class="btn btn-danger-solid" @click="confirmDeleteBean()">Delete Bean</button>
      </div>
    </div>
  </div>
  </template>

  <!-- ═══════════════════════════════════════
       TAB BAR
       ═══════════════════════════════════════ -->
  <nav class="tab-bar">
    <button class="tab-btn" :class="{ 'active': currentTab === 'today' }" @click="activateTab('today')">
      <span class="tab-icon">&#9749;</span>
      <span>Today</span>
    </button>
    <button class="tab-btn" :class="{ 'active': currentTab === 'beans' }" @click="activateTab('beans')">
      <span class="tab-icon">&#127793;</span>
      <span>Coffee</span>
    </button>
    <button class="tab-btn" :class="{ 'active': currentTab === 'calendar' }" @click="activateTab('calendar')">
      <span class="tab-icon">&#128197;</span>
      <span>Calendar</span>
    </button>
  </nav>

</div>

<script>
document.addEventListener('alpine:init', () => {
  /** Reusable numeric stepper component. formName is the key on the parent x-data (e.g. 'shotForm' or 'optimalForm'). */
  function createStepper(formName) {
    return () => ({
      stField: '', stMin: 0, stMax: 100, stDefault: 0,
      stInit(field, min, max, defaultWhenEmpty) {
        this.stField = field; this.stMin = min; this.stMax = max; this.stDefault = defaultWhenEmpty;
      },
      stForm() { return this[formName]; },
      stVal() {
        const v = this.stForm()[this.stField];
        return (v !== null && v !== undefined && v !== '') ? Number(v) : null;
      },
      stPlaceholder() { return this.stDefault.toString(); },
      stInc() {
        const cur = this.stVal();
        this.stForm()[this.stField] = cur === null ? this.stDefault : Math.min(this.stMax, cur + 1);
      },
      stDec() {
        const cur = this.stVal();
        this.stForm()[this.stField] = cur === null ? Math.max(this.stMin, this.stDefault - 1) : Math.max(this.stMin, cur - 1);
      },
      stOnFocus(e) { e.target.select(); },
      stOnInput(e) {
        const raw = e.target.value.trim();
        if (raw === '') { this.stForm()[this.stField] = null; return; }
        const num = parseInt(raw, 10);
        if (!isNaN(num)) this.stForm()[this.stField] = Math.max(this.stMin, Math.min(this.stMax, num));
      }
    });
  }
  Alpine.data('stepper', createStepper('shotForm'));
  Alpine.data('optimalStepper', createStepper('optimalForm'));

  /** Custom date picker: x-if (no x-show) + document close listener to avoid flicker from @click.outside. */
  Alpine.data('datePicker', () => ({
    dpOpen: false,
    _dpCloseListener: null,
    dpMonth: new Date().getMonth(),
    dpYear: new Date().getFullYear(),
    dpModelKey: '',
    dpInit(modelKey) {
      this.dpModelKey = modelKey;
      const val = this.dpValue();
      if (val) {
        const d = new Date(val + 'T00:00:00');
        this.dpMonth = d.getMonth();
        this.dpYear = d.getFullYear();
      }
      this.$watch('dpOpen', (open) => {
        if (open) this.$nextTick(() => this.dpAddCloseListener());
        else this.dpRemoveCloseListener();
      });
    },
    dpAddCloseListener() {
      this.dpRemoveCloseListener();
      const handler = (e) => {
        const wrapper = this.$refs.dateInputWrapper;
        const picker = this.$refs.datepickerEl;
        if (wrapper?.contains(e.target) || picker?.contains(e.target)) return;
        this.dpOpen = false;
        this.dpRemoveCloseListener();
      };
      this._dpCloseListener = handler;
      // Use capture phase so click is caught before @click.stop in modals
      document.addEventListener('click', handler, true);
    },
    dpRemoveCloseListener() {
      if (this._dpCloseListener) {
        document.removeEventListener('click', this._dpCloseListener, true);
        this._dpCloseListener = null;
      }
    },
    dpValue() {
      const keys = this.dpModelKey.split('.');
      let val = this;
      for (const k of keys) val = val?.[k];
      return val || '';
    },
    dpSetValue(v) {
      const keys = this.dpModelKey.split('.');
      let obj = this;
      for (let i = 0; i < keys.length - 1; i++) obj = obj[keys[i]];
      obj[keys[keys.length - 1]] = v;
    },
    dpDisplayValue() {
      const v = this.dpValue();
      if (!v) return '';
      const d = new Date(v + 'T00:00:00');
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    },
    dpMonthYearLabel() {
      const d = new Date(this.dpYear, this.dpMonth, 1);
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
    },
    dpPrevMonth() {
      if (this.dpMonth === 0) { this.dpMonth = 11; this.dpYear--; }
      else { this.dpMonth--; }
    },
    dpNextMonth() {
      if (this.dpMonth === 11) { this.dpMonth = 0; this.dpYear++; }
      else { this.dpMonth++; }
    },
    dpGoToday() {
      const today = new Date();
      this.dpMonth = today.getMonth();
      this.dpYear = today.getFullYear();
    },
    dpToggle() {
      this.dpOpen = !this.dpOpen;
    },
    dpSelect(dateStr) {
      this.dpSetValue(dateStr);
      this.dpOpen = false;
    },
    dpClear() {
      this.dpSetValue('');
    },
    dpDays() {
      const days = [];
      const firstDay = new Date(this.dpYear, this.dpMonth, 1);
      const lastDay = new Date(this.dpYear, this.dpMonth + 1, 0);
      const today = new Date();
      const selectedVal = this.dpValue();

      // Sunday-based week (0=Sun, 6=Sat)
      const startDow = firstDay.getDay();

      // Previous month days
      const prevMonth = new Date(this.dpYear, this.dpMonth, 0);
      for (let i = startDow - 1; i >= 0; i--) {
        const day = prevMonth.getDate() - i;
        const d = new Date(this.dpYear, this.dpMonth - 1, day);
        const dateStr = localDateStr(d);
        days.push({ key: 'prev-' + day, day, date: dateStr, outside: true, isToday: false, isSelected: false });
      }

      // Current month days
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const d = new Date(this.dpYear, this.dpMonth, day);
        const dateStr = localDateStr(d);
        const isToday = d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate();
        const isSelected = selectedVal === dateStr;
        days.push({ key: 'cur-' + day, day, date: dateStr, outside: false, isToday, isSelected });
      }

      // Next month days to fill exactly 5 weeks (35 cells)
      const remaining = Math.max(0, 35 - days.length);
      for (let i = 1; i <= remaining; i++) {
        const d = new Date(this.dpYear, this.dpMonth + 1, i);
        const dateStr = localDateStr(d);
        days.push({ key: 'next-' + i, day: i, date: dateStr, outside: true, isToday: false, isSelected: false });
      }

      return days;
    }
  }));
});
const BAR_COLORS = ['#C2714F','#8B9E7C','#C4A34D','#7B5B8D','#5B8E8E','#B87333','#A0695B'];

// Freshness thresholds (centralized constants)
const FRESHNESS_RESTING_DAYS = 7;
const FRESHNESS_OPTIMAL_DAYS = 21;

// Espresso extraction standards (universal targets)
const EXTRACTION_TIME_FAST = 22;           // Below: under-extracted
const EXTRACTION_TIME_SLIGHTLY_FAST = 25;  // 22-24: slightly fast
const EXTRACTION_TIME_STANDARD_MAX = 30;   // 25-30: standard range
const EXTRACTION_TIME_SLIGHTLY_SLOW = 35;  // 31-35: slightly slow
                                           // Above 35: over-extracted

const BREW_RATIO_VERY_LOW = 1.5;           // Below: very low yield
const BREW_RATIO_LOW = 1.8;               // 1.5-1.79: low yield
const BREW_RATIO_STANDARD_MAX = 2.2;      // 1.8-2.2: standard range
const BREW_RATIO_HIGH = 2.5;              // 2.21-2.5: high yield
                                           // Above 2.5: very high yield

function hexToRgba(hex, alpha) {
  const m = hex.match(/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i);
  if (!m) return hex;
  return `rgba(${parseInt(m[1], 16)},${parseInt(m[2], 16)},${parseInt(m[3], 16)},${alpha})`;
}


function localDateStr(d) {
  if (!d) d = new Date();
  if (typeof d === 'string') d = new Date(d);
  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
}

function addDays(date, days) { const d = new Date(date); d.setDate(d.getDate() + days); return d; }
function daysBetween(d1, d2) { return Math.floor((new Date(d2) - new Date(d1)) / 86400000); }

/** Convert any legacy numeric rating (1-5) or valid string to 'bad'|'okay'|'great'|'perfect'|null */
function normalizeRating(r) {
  if (r == null) return null;
  if (r === 'bad' || r === 'okay' || r === 'great' || r === 'perfect') return r;
  if (typeof r === 'number') {
    if (r <= 2) return 'bad';
    if (r === 3) return 'okay';
    if (r === 4) return 'great';
    return 'perfect';
  }
  return null;
}

const TAB_ORDER = ['today', 'beans', 'calendar'];
const FRESHNESS_SORT_ORDER = { optimal: 0, resting: 1, past: 2, unknown: 3 };
const SHOT_DEFAULTS = { grindSize: 5, doseIn: 18, yieldOut: 36, extractionTime: 25 };
const BACKUP_FORMAT_VERSION = 1;
const BACKUP_LAST_EXPORTED_KEY = 'coffee_backup_last_exported_at';
const BACKUP_LAST_IMPORTED_KEY = 'coffee_backup_last_imported_at';

function app() {
  return {
    beans: [], shots: [],
    currentTab: 'today', beansView: 'list',
    touchTabSwipeEnabled: false,
    tabSwipeStartX: 0, tabSwipeStartY: 0,
    tabSwipeTracking: false, tabSwipeAxis: '',
    tabSwipeOffsetX: 0, tabSwipeWidth: 0, tabSwipeAdjacentTab: '',
    selectedBeanId: null, editingBeanId: null,
    showShotForm: false, shotFormBeanId: null, shotFormReturnTo: null, editingShotId: null,
    showBeanFormModal: false, beanFormContext: 'beans', beanFormError: '',
    showDeleteBeanDialog: false,
    showBackupPanel: false,
    dailySelectedBeanId: '', dailyLastShot: null,
    _pendingDuplicateBean: null,
    editingOptimalBeanId: null,
    optimalForm: { grindSize: null, doseIn: null, yieldOut: null, extractionTime: null },
    beanForm: { name: '', roaster: '', roastDate: '', notes: '' },
    shotForm: { grindSize: null, doseIn: null, yieldOut: null, extractionTime: null, rating: null, notes: '', shotDate: '', saveAsBestDialIn: false },
    backupLastExportedAt: '',
    backupLastImportedAt: '',
    backupNoticeType: '',
    backupNoticeMessage: '',
    backupImportPreview: null,
    calendarYear: new Date().getFullYear(), calendarMonth: new Date().getMonth(), calendarFilteredBeanIds: [],

    init() {
      const savedBeans = localStorage.getItem('coffee_beans');
      const savedShots = localStorage.getItem('coffee_shots');
      this.touchTabSwipeEnabled = this.isTouchTabSwipeAvailable();
      if (savedBeans) {
        this.beans = JSON.parse(savedBeans);
        this.shots = savedShots ? JSON.parse(savedShots) : [];

        // Migrate: ensure isArchived field exists on all beans
        this.beans.forEach(b => { if (b.isArchived === undefined) b.isArchived = false; });

        // Migrate: seed optimal settings from first shot if not yet set
        this.beans.forEach(b => {
          if (b.optimalGrindSize === undefined && b.optimalDoseIn === undefined && b.optimalYieldOut === undefined) {
            const firstShot = this.shots.find(s => s.beanId === b.id);
            if (firstShot) {
              b.optimalGrindSize = firstShot.grindSize;
              b.optimalDoseIn = firstShot.doseIn;
              b.optimalYieldOut = firstShot.yieldOut;
              b.optimalExtractionTime = firstShot.extractionTime ?? null;
            }
          }
        });

        // Migrate: convert legacy numeric ratings to string labels
        let shotsDirty = false;
        this.shots.forEach(s => {
          if (typeof s.rating === 'number') {
            s.rating = normalizeRating(s.rating);
            shotsDirty = true;
          }
        });
        if (shotsDirty) this.saveShots();
      } else {
        this.saveBeans();
        this.saveShots();
      }
      this.backupLastExportedAt = localStorage.getItem(BACKUP_LAST_EXPORTED_KEY) || '';
      this.backupLastImportedAt = localStorage.getItem(BACKUP_LAST_IMPORTED_KEY) || '';
    },

    setBackupNotice(type, message) {
      this.backupNoticeType = type;
      this.backupNoticeMessage = message;
    },

    openBackupPanel() {
      this.showBackupPanel = true;
    },

    closeBackupPanel() {
      this.showBackupPanel = false;
    },

    normalizeIsoDateOnly(value) {
      if (typeof value !== 'string' || !value.trim()) return '';
      const trimmed = value.trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
        const parsedDate = new Date(trimmed + 'T00:00:00');
        return (!isNaN(parsedDate.getTime()) && localDateStr(parsedDate) === trimmed) ? trimmed : '';
      }
      const parsed = new Date(trimmed);
      if (isNaN(parsed.getTime())) return '';
      return localDateStr(parsed);
    },

    normalizeIsoDateTime(value) {
      if (typeof value !== 'string' || !value.trim()) return '';
      const parsed = new Date(value.trim());
      if (isNaN(parsed.getTime())) return '';
      return parsed.toISOString();
    },

    normalizeImportedBeanRating(value) {
      const parsed = Number(value);
      if (!Number.isFinite(parsed)) return null;
      return Math.max(1, Math.min(5, Math.round(parsed)));
    },

    normalizeImportedBean(rawBean) {
      if (!rawBean || typeof rawBean !== 'object') return null;
      const id = typeof rawBean.id === 'string' ? rawBean.id.trim() : '';
      const name = typeof rawBean.name === 'string' ? rawBean.name.trim() : '';
      const roaster = typeof rawBean.roaster === 'string' ? rawBean.roaster.trim() : '';
      if (!id || !name || !roaster) return null;

      return {
        id,
        name,
        roaster,
        roastDate: this.normalizeIsoDateOnly(rawBean.roastDate),
        rating: this.normalizeImportedBeanRating(rawBean.rating),
        notes: typeof rawBean.notes === 'string' ? rawBean.notes : '',
        isArchived: !!rawBean.isArchived,
        optimalGrindSize: this.toNullableOneDecimal(rawBean.optimalGrindSize),
        optimalDoseIn: this.toNullableOneDecimal(rawBean.optimalDoseIn),
        optimalYieldOut: this.toNullableOneDecimal(rawBean.optimalYieldOut),
        optimalExtractionTime: this.toNullableOneDecimal(rawBean.optimalExtractionTime),
        createdAt: this.normalizeIsoDateTime(rawBean.createdAt) || new Date().toISOString()
      };
    },

    normalizeImportedShot(rawShot) {
      if (!rawShot || typeof rawShot !== 'object') return null;
      const id = typeof rawShot.id === 'string' ? rawShot.id.trim() : '';
      const beanId = typeof rawShot.beanId === 'string' ? rawShot.beanId.trim() : '';
      const grindSize = this.toNullableInt(rawShot.grindSize);
      const doseIn = this.toNullableInt(rawShot.doseIn);
      const yieldOut = this.toNullableInt(rawShot.yieldOut);
      const extractionTime = this.toNullableInt(rawShot.extractionTime);
      if (!id || !beanId || grindSize == null || doseIn == null || yieldOut == null || extractionTime == null) return null;

      const createdAt = this.normalizeIsoDateTime(rawShot.createdAt) || new Date().toISOString();
      return {
        id,
        beanId,
        grindSize,
        doseIn,
        yieldOut,
        extractionTime,
        rating: normalizeRating(rawShot.rating),
        notes: typeof rawShot.notes === 'string' ? rawShot.notes : '',
        shotDate: this.normalizeIsoDateOnly(rawShot.shotDate) || createdAt.slice(0, 10),
        createdAt
      };
    },

    extractBackupPayload(parsed) {
      if (!parsed || typeof parsed !== 'object') {
        throw new Error('This file is not a valid backup object.');
      }
      const source = parsed.data && typeof parsed.data === 'object' ? parsed.data : parsed;
      if (!Array.isArray(source.beans) || !Array.isArray(source.shots)) {
        throw new Error('This backup file is missing beans or shots.');
      }
      return source;
    },

    prepareBackupImportPreview(jsonText, fileName) {
      let parsed;
      try {
        parsed = JSON.parse(jsonText);
      } catch (_error) {
        throw new Error('Could not read this file. Please select a backup JSON file from this app.');
      }

      const payload = this.extractBackupPayload(parsed);
      const importedBeans = [];
      const importedShots = [];
      let invalidBeans = 0;
      let invalidShots = 0;
      let duplicateBeansInFile = 0;
      let duplicateShotsInFile = 0;
      let orphanShots = 0;
      let skippedExistingBeans = 0;
      let skippedExistingShots = 0;

      const existingBeanIds = new Set(this.beans.map(bean => bean.id));
      const existingShotIds = new Set(this.shots.map(shot => shot.id));
      const seenBeanIdsInFile = new Set();
      const seenShotIdsInFile = new Set();

      for (const rawBean of payload.beans) {
        const bean = this.normalizeImportedBean(rawBean);
        if (!bean) {
          invalidBeans++;
          continue;
        }
        if (seenBeanIdsInFile.has(bean.id)) {
          duplicateBeansInFile++;
          continue;
        }
        seenBeanIdsInFile.add(bean.id);
        if (existingBeanIds.has(bean.id)) {
          skippedExistingBeans++;
          continue;
        }
        importedBeans.push(bean);
      }

      const allBeanIdsAfterMerge = new Set([...existingBeanIds, ...importedBeans.map(bean => bean.id)]);
      for (const rawShot of payload.shots) {
        const shot = this.normalizeImportedShot(rawShot);
        if (!shot) {
          invalidShots++;
          continue;
        }
        if (seenShotIdsInFile.has(shot.id)) {
          duplicateShotsInFile++;
          continue;
        }
        seenShotIdsInFile.add(shot.id);
        if (existingShotIds.has(shot.id)) {
          skippedExistingShots++;
          continue;
        }
        if (!allBeanIdsAfterMerge.has(shot.beanId)) {
          orphanShots++;
          continue;
        }
        importedShots.push(shot);
      }

      return {
        fileName: fileName || 'backup.json',
        newBeans: importedBeans.length,
        newShots: importedShots.length,
        skippedExisting: skippedExistingBeans + skippedExistingShots,
        invalidOrSkipped: invalidBeans + invalidShots + duplicateBeansInFile + duplicateShotsInFile + orphanShots,
        beansToImport: importedBeans,
        shotsToImport: importedShots
      };
    },

    triggerBackupImport() {
      if (this.$refs.backupImportInput) {
        this.$refs.backupImportInput.click();
      }
    },

    clearBackupImportPreview() {
      this.backupImportPreview = null;
      if (this.$refs.backupImportInput) this.$refs.backupImportInput.value = '';
      this.setBackupNotice('info', 'Import canceled. No data was changed.');
    },

    async onBackupFileSelected(event) {
      const file = event?.target?.files?.[0];
      this.backupImportPreview = null;
      if (!file) return;

      try {
        const text = await file.text();
        const preview = this.prepareBackupImportPreview(text, file.name);
        this.backupImportPreview = preview;
        if (preview.newBeans === 0 && preview.newShots === 0) {
          this.setBackupNotice('info', 'Backup is valid, but there is nothing new to import.');
        } else {
          this.setBackupNotice('info', `Review and confirm import. This will add ${preview.newBeans} beans and ${preview.newShots} shots.`);
        }
      } catch (error) {
        this.setBackupNotice('error', error?.message || 'Could not import this file.');
      }
    },

    confirmBackupImport() {
      const preview = this.backupImportPreview;
      if (!preview) {
        this.setBackupNotice('error', 'Select a backup file first.');
        return;
      }

      if (preview.newBeans === 0 && preview.newShots === 0) {
        this.setBackupNotice('info', 'Nothing new to import. Existing data is unchanged.');
        this.backupImportPreview = null;
        if (this.$refs.backupImportInput) this.$refs.backupImportInput.value = '';
        return;
      }

      this.beans = this.beans.concat(preview.beansToImport);
      this.shots = this.shots.concat(preview.shotsToImport);
      this.saveBeans();
      this.saveShots();

      const now = new Date().toISOString();
      this.backupLastImportedAt = now;
      localStorage.setItem(BACKUP_LAST_IMPORTED_KEY, now);

      this.backupImportPreview = null;
      if (this.$refs.backupImportInput) this.$refs.backupImportInput.value = '';
      this.setBackupNotice('success', `Import complete. Added ${preview.newBeans} beans and ${preview.newShots} shots. Existing entries were kept.`);
    },

    exportBackup() {
      try {
        const exportedAt = new Date().toISOString();
        const payload = {
          app: 'coffee-journal',
          formatVersion: BACKUP_FORMAT_VERSION,
          exportedAt,
          data: {
            beans: this.beans,
            shots: this.shots
          }
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `coffee-journal-backup-${localDateStr()}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);

        this.backupLastExportedAt = exportedAt;
        localStorage.setItem(BACKUP_LAST_EXPORTED_KEY, exportedAt);
        this.setBackupNotice('success', 'Backup exported. Save this file somewhere safe.');
      } catch (_error) {
        this.setBackupNotice('error', 'Export failed. Please try again.');
      }
    },

    scrollContentToTop() {
      const contentArea = document.querySelector('.content-area');
      if (contentArea) contentArea.scrollTop = 0;
    },

    resetDailySelection() {
      this.dailySelectedBeanId = '';
      this.dailyLastShot = null;
    },

    resetBeanFormState() {
      this.editingBeanId = null;
      this._pendingDuplicateBean = null;
      this.beanFormContext = 'beans';
      this.beanFormError = '';
    },

    setBeanForm(bean = null) {
      this.beanForm = {
        name: bean?.name || '',
        roaster: bean?.roaster || '',
        roastDate: bean?.roastDate ? String(bean.roastDate).slice(0, 10) : '',
        notes: bean?.notes ?? ''
      };
    },

    createDuplicateBean(source, roastDate = localDateStr()) {
      return {
        id: crypto.randomUUID(),
        name: source.name,
        roaster: source.roaster,
        roastDate,
        rating: source.rating,
        notes: source.notes ?? '',
        isArchived: false,
        optimalGrindSize: source.optimalGrindSize,
        optimalDoseIn: source.optimalDoseIn,
        optimalYieldOut: source.optimalYieldOut,
        optimalExtractionTime: source.optimalExtractionTime,
        createdAt: new Date().toISOString()
      };
    },

    beanHasOptimalSettings(bean) {
      return bean.optimalGrindSize != null || bean.optimalDoseIn != null || bean.optimalYieldOut != null;
    },

    beanSourceDateValue(bean) {
      return bean.roastDate || bean.createdAt || '';
    },

    toNullableInt(value) {
      return value != null && value !== '' ? Math.round(Number(value)) : null;
    },

    toNullableOneDecimal(value) {
      const parsed = parseFloat(value);
      return value === '' || value == null || isNaN(parsed) ? null : Math.round(parsed * 10) / 10;
    },

    isTouchTabSwipeAvailable() {
      return typeof window !== 'undefined'
        && (window.matchMedia('(pointer: coarse)').matches || navigator.maxTouchPoints > 0);
    },

    getTabIndex(tab) {
      return TAB_ORDER.indexOf(tab);
    },

    activateTab(tab) {
      if (!TAB_ORDER.includes(tab)) return;
      if (tab === 'beans' && this.beansView !== 'list') {
        this.beansView = 'list';
        this.selectedBeanId = null;
      }
      this.currentTab = tab;
      this.scrollContentToTop();
    },

    isTabSwipeDragging() {
      return this.tabSwipeTracking && this.tabSwipeAxis === 'x';
    },

    tabPaneStyle(tab) {
      const isActive = tab === this.currentTab;
      if (!this.isTabSwipeDragging()) {
        return isActive ? 'display:block;position:relative;' : 'display:none;';
      }

      if (isActive) {
        return `display:block;position:relative;z-index:2;transform:translateX(${this.tabSwipeOffsetX}px);`;
      }

      if (tab === this.tabSwipeAdjacentTab) {
        const base = this.tabSwipeOffsetX < 0 ? this.tabSwipeWidth : -this.tabSwipeWidth;
        const offset = base + this.tabSwipeOffsetX;
        return `display:block;position:absolute;top:0;left:0;width:100%;z-index:1;transform:translateX(${offset}px);`;
      }

      return 'display:none;';
    },

    getTabSwipeEdgeWidth(width) {
      return width * 0.28;
    },

    isTabSwipeStartInEdge(clientX, bounds) {
      if (!bounds) return false;
      const localX = clientX - bounds.left;
      const edge = this.getTabSwipeEdgeWidth(bounds.width);
      return localX <= edge || localX >= (bounds.width - edge);
    },

    isTabSwipeBlockedTarget(target) {
      if (!target || typeof target.closest !== 'function') return false;
      return !!target.closest('input, textarea, select, button, a, [contenteditable="true"], .today-shot-swipe, .bean-picker-dropdown, .custom-datepicker, .archive-picker, .fill-from-previous-picker, .panel, .legend-item');
    },

    getAdjacentTabForOffset(offset) {
      const currentIndex = this.getTabIndex(this.currentTab);
      if (currentIndex === -1 || offset === 0) return '';
      const nextIndex = offset < 0 ? currentIndex + 1 : currentIndex - 1;
      if (nextIndex < 0 || nextIndex >= TAB_ORDER.length) return '';
      return TAB_ORDER[nextIndex];
    },

    onTabSwipeStart(event) {
      this.resetTabSwipe();
      if (!this.touchTabSwipeEnabled) return;
      if (this.showShotForm || this.showBeanFormModal || this.showDeleteBeanDialog || this.showBackupPanel) return;
      if (!event.touches || event.touches.length !== 1) return;
      if (this.isTabSwipeBlockedTarget(event.target)) return;

      const touch = event.touches[0];
      const bounds = event.currentTarget?.getBoundingClientRect();
      if (!this.isTabSwipeStartInEdge(touch.clientX, bounds)) return;

      this.tabSwipeStartX = touch.clientX;
      this.tabSwipeStartY = touch.clientY;
      this.tabSwipeWidth = bounds.width;
      this.tabSwipeTracking = true;
      this.tabSwipeAxis = '';
      this.tabSwipeOffsetX = 0;
      this.tabSwipeAdjacentTab = '';
    },

    onTabSwipeMove(event) {
      if (!this.tabSwipeTracking) return;
      if (!event.touches || event.touches.length !== 1) {
        this.resetTabSwipe();
        return;
      }

      const touch = event.touches[0];
      const dx = touch.clientX - this.tabSwipeStartX;
      const dy = touch.clientY - this.tabSwipeStartY;
      const absDx = Math.abs(dx);
      const absDy = Math.abs(dy);

      if (!this.tabSwipeAxis) {
        if (absDx < 10 && absDy < 10) return;
        this.tabSwipeAxis = absDx > absDy ? 'x' : 'y';
        if (this.tabSwipeAxis === 'y') {
          this.resetTabSwipe();
          return;
        }
      }

      if (this.tabSwipeAxis !== 'x') return;

      let dragX = dx;
      const maxDrag = this.tabSwipeWidth || window.innerWidth;
      dragX = Math.max(-maxDrag, Math.min(maxDrag, dragX));

      // At boundaries, apply resistance so it feels natural but doesn't fully slide a non-existent tab.
      const adjacentTab = this.getAdjacentTabForOffset(dragX);
      if (!adjacentTab) {
        dragX *= 0.28;
      }

      this.tabSwipeOffsetX = dragX;
      this.tabSwipeAdjacentTab = adjacentTab;
      event.preventDefault();
    },

    onTabSwipeEnd() {
      if (!this.tabSwipeTracking) return;
      if (this.tabSwipeAxis !== 'x') {
        this.resetTabSwipe();
        return;
      }

      const threshold = Math.max(56, (this.tabSwipeWidth || window.innerWidth) * 0.18);
      if (this.tabSwipeAdjacentTab && Math.abs(this.tabSwipeOffsetX) >= threshold) {
        this.activateTab(this.tabSwipeAdjacentTab);
      }
      this.resetTabSwipe();
    },

    resetTabSwipe() {
      this.tabSwipeTracking = false;
      this.tabSwipeAxis = '';
      this.tabSwipeStartX = 0;
      this.tabSwipeStartY = 0;
      this.tabSwipeOffsetX = 0;
      this.tabSwipeWidth = 0;
      this.tabSwipeAdjacentTab = '';
    },

    saveBeans() { localStorage.setItem('coffee_beans', JSON.stringify(this.beans)); },
    saveShots() { localStorage.setItem('coffee_shots', JSON.stringify(this.shots)); },

    getBeanById(id) { return this.beans.find(b => b.id === id) || null; },
    getShotsForBean(id) {
      return this.shots.filter(s => s.beanId === id).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    },
    getLastShot(beanId) { const ss = this.getShotsForBean(beanId); return ss.length > 0 ? ss[0] : null; },
    getShotDialInDefaults(beanId) {
      const bean = this.getBeanById(beanId);
      return {
        grindSize: bean?.optimalGrindSize ?? SHOT_DEFAULTS.grindSize,
        doseIn: bean?.optimalDoseIn ?? SHOT_DEFAULTS.doseIn,
        yieldOut: bean?.optimalYieldOut ?? SHOT_DEFAULTS.yieldOut,
        extractionTime: bean?.optimalExtractionTime ?? SHOT_DEFAULTS.extractionTime
      };
    },

    get todayShots() {
      const todayStr = localDateStr();
      return this.shots
        .filter(s => {
          const shotDate = s.shotDate || s.createdAt.split('T')[0];
          return shotDate === todayStr;
        })
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    },
    get selectedBean() { return this.getBeanById(this.selectedBeanId); },

    get sortedBeans() {
      return [...this.beans].sort((a,b) => {
        if (!!a.isArchived !== !!b.isArchived) return a.isArchived ? 1 : -1;
        const fa = this.getFreshness(a), fb = this.getFreshness(b);
        if (FRESHNESS_SORT_ORDER[fa.status] !== FRESHNESS_SORT_ORDER[fb.status]) {
          return FRESHNESS_SORT_ORDER[fa.status] - FRESHNESS_SORT_ORDER[fb.status];
        }
        return new Date(b.roastDate || 0) - new Date(a.roastDate || 0);
      });
    },

    get currentBeans() { return this.sortedBeans.filter(b => !b.isArchived); },
    get archivedBeans() { return this.sortedBeans.filter(b => b.isArchived); },

    // De-duplicated list of beans for "fill from previous" picker
    // Groups by name+roaster (case-insensitive), picks best representative:
    // prefer bean with optimal settings filled in, then most recent
    getUniqueBeanSources(options = {}) {
      const archivedOnly = options.archivedOnly === true;
      const groups = new Map();
      for (const bean of this.beans) {
        if (archivedOnly && !bean.isArchived) continue;
        const key = ((bean.name || '') + '|' + (bean.roaster || '')).toLowerCase();
        const current = groups.get(key);
        if (!current) {
          groups.set(key, bean);
          continue;
        }
        const beanHasSettings = this.beanHasOptimalSettings(bean);
        const currentHasSettings = this.beanHasOptimalSettings(current);
        if (beanHasSettings !== currentHasSettings) {
          if (beanHasSettings) groups.set(key, bean);
          continue;
        }
        if (this.beanSourceDateValue(bean) > this.beanSourceDateValue(current)) {
          groups.set(key, bean);
        }
      }
      // Sort final list alphabetically by name
      return Array.from(groups.values()).sort((a, b) => a.name.localeCompare(b.name));
    },

    getFreshness(bean) {
      if (!bean?.roastDate) return { status: 'unknown', label: 'No roast date', detail: '' };
      const days = daysBetween(bean.roastDate, new Date());
      if (days < FRESHNESS_RESTING_DAYS) {
        return { status: 'resting', label: 'Resting', detail: `${FRESHNESS_RESTING_DAYS - days} days until peak` };
      }
      if (days <= FRESHNESS_OPTIMAL_DAYS) {
        return { status: 'optimal', label: 'At Peak', detail: `${FRESHNESS_OPTIMAL_DAYS - days} days remaining` };
      }
      return { status: 'past', label: 'Past Peak', detail: `Past peak by ${days - FRESHNESS_OPTIMAL_DAYS} days` };
    },

    openBeanForm(id, options = {}) {
      const context = options.context || 'beans';
      this.beanFormContext = context;
      this.beanFormError = '';
      this._pendingDuplicateBean = null;
      this.editingBeanId = id;
      if (id) {
        const b = this.getBeanById(id);
        if (!b) return;
        this.setBeanForm(b);
      } else {
        this.setBeanForm();
      }
      if (context === 'today-picker') {
        this.showBeanFormModal = true;
        return;
      }
      this.showBeanFormModal = false;
      this.beansView = 'form';
      this.scrollContentToTop();
    },

    duplicateBean(beanId) {
      const source = this.getBeanById(beanId);
      if (!source) return;
      const newBean = this.createDuplicateBean(source);
      // Pre-fill the form for user review/edit
      this.setBeanForm(newBean);
      this.editingBeanId = null;
      this._pendingDuplicateBean = newBean; // Store for saveBean to use
      this.beanFormContext = 'beans';
      this.showBeanFormModal = false;
      this.beanFormError = '';
      this.currentTab = 'beans';
      this.beansView = 'form';
      this.scrollContentToTop();
    },

    // Legacy alias for existing "restore from archive" in Today tab
    duplicateFromArchive(beanId) {
      this.duplicateBean(beanId);
    },

    // Fill bean form fields from a source bean without navigating (used in modal)
    fillBeanFormFrom(beanId) {
      const source = this.getBeanById(beanId);
      if (!source) return;
      this._pendingDuplicateBean = this.createDuplicateBean(source);
      this.setBeanForm(this._pendingDuplicateBean);
    },

    normalizeBeanName(name) {
      return (name || '').trim().toLowerCase();
    },

    beanNameExists(name, excludeId = null, options = {}) {
      const includeArchived = options.includeArchived === true;
      const normalized = this.normalizeBeanName(name);
      if (!normalized) return false;
      return this.beans.some(b => {
        if (!includeArchived && b.isArchived) return false;
        return this.normalizeBeanName(b.name) === normalized && b.id !== excludeId;
      });
    },

    openAddBeanFromToday() {
      this.resetDailySelection();
      this.openBeanForm(null, { context: 'today-picker' });
    },

    saveBean() {
      const name = (this.beanForm.name || '').trim();
      const roaster = (this.beanForm.roaster || '').trim();
      const roastDate = this.beanForm.roastDate ? String(this.beanForm.roastDate).slice(0, 10) : '';
      if (!name || !roaster) return;
      this.beanFormError = '';
      const isTodayPickerFlow = this.beanFormContext === 'today-picker';
      if (isTodayPickerFlow && this.beanNameExists(name, this.editingBeanId, { includeArchived: false })) {
        this.beanFormError = 'Bean already exists. Choose a different name.';
        return;
      }
      const wasEditing = !!this.editingBeanId;
      let savedBeanId = null;
      if (this.editingBeanId) {
        const idx = this.beans.findIndex(b => b.id === this.editingBeanId);
        if (idx !== -1) {
          const updated = { ...this.beans[idx], name, roaster, roastDate, notes: this.beanForm.notes ?? '' };
          this.beans[idx] = updated;
          savedBeanId = updated.id;
        }
      } else if (this._pendingDuplicateBean) {
        // Duplicating from archive — preserve optimal settings
        const pending = this._pendingDuplicateBean;
        const duplicatedBean = {
          ...pending,
          name, roaster, roastDate,
          notes: this.beanForm.notes ?? ''
        };
        this.beans.push(duplicatedBean);
        savedBeanId = duplicatedBean.id;
        this._pendingDuplicateBean = null;
      } else {
        const newBean = {
          id: crypto.randomUUID(), name, roaster, roastDate,
          rating: null, notes: this.beanForm.notes ?? '',
          isArchived: false, createdAt: new Date().toISOString()
        };
        this.beans.push(newBean);
        savedBeanId = newBean.id;
      }
      this.saveBeans();
      if (isTodayPickerFlow) {
        this.showBeanFormModal = false;
        this.resetBeanFormState();
        this.dailySelectedBeanId = savedBeanId || '';
        this.dailyLastShot = null;
        if (this.dailySelectedBeanId) this.onDailyBeanSelect();
        return;
      }
      this.beansView = wasEditing ? 'detail' : 'list';
      this.resetBeanFormState();
      this.scrollContentToTop();
    },

    cancelBeanForm() {
      if (this.beanFormContext === 'today-picker') {
        this.showBeanFormModal = false;
        this.resetBeanFormState();
        this.resetDailySelection();
        return;
      }
      this.beansView = this.editingBeanId ? 'detail' : 'list';
      this.resetBeanFormState();
      this.scrollContentToTop();
    },

    openDeleteBeanDialog() {
      if (!this.selectedBeanId) return;
      this.showDeleteBeanDialog = true;
    },

    closeDeleteBeanDialog() {
      this.showDeleteBeanDialog = false;
    },

    confirmDeleteBean() {
      if (!this.selectedBeanId) {
        this.closeDeleteBeanDialog();
        return;
      }
      this.deleteBean(this.selectedBeanId);
      this.closeDeleteBeanDialog();
    },

    deleteBean(id) {
      this.beans = this.beans.filter(b => b.id !== id);
      this.shots = this.shots.filter(s => s.beanId !== id);
      this.saveBeans();
      this.saveShots();
      this.showDeleteBeanDialog = false;
      this.beansView = 'list';
      this.selectedBeanId = null;
      this.scrollContentToTop();
    },

    selectBean(id) {
      this.editingOptimalBeanId = null;
      this.selectedBeanId = id;
      this.beansView = 'detail';
      this.scrollContentToTop();
    },

    archiveBean(id) {
      const bean = this.getBeanById(id);
      if (bean) {
        bean.isArchived = true;
        this.saveBeans();
        // Close shot form if it references this bean
        if (this.showShotForm && this.shotFormBeanId === id) {
          this.closeShotForm();
        }
        if (this.dailySelectedBeanId === id) {
          this.resetDailySelection();
        }
        this.selectedBeanId = null;
        this.beansView = 'list';
        this.scrollContentToTop();
      }
    },

    unarchiveBean(id) {
      const bean = this.getBeanById(id);
      if (bean) { bean.isArchived = false; this.saveBeans(); }
    },

    updateBeanRating(n) {
      const bean = this.getBeanById(this.selectedBeanId);
      if (bean) { bean.rating = bean.rating === n ? null : n; this.saveBeans(); }
    },

    openShotForm(beanId) {
      this.editingShotId = null;
      this.shotFormBeanId = beanId;
      this.shotFormReturnTo = this.currentTab;
      const today = localDateStr();
      this.shotForm = {
        grindSize: null,
        doseIn: null,
        yieldOut: null,
        extractionTime: null,
        rating: null, notes: '', shotDate: today,
        saveAsBestDialIn: false
      };
      this.showShotForm = true;
    },

    openShotFormForEdit(shot) {
      this.editingShotId = shot.id;
      this.shotFormBeanId = shot.beanId;
      this.shotFormReturnTo = this.currentTab;
      // Use shotDate if exists, otherwise derive from createdAt (migration)
      const shotDate = shot.shotDate || shot.createdAt.split('T')[0];
      this.shotForm = {
        grindSize: shot.grindSize,
        doseIn: shot.doseIn,
        yieldOut: shot.yieldOut,
        extractionTime: shot.extractionTime ?? null,
        rating: normalizeRating(shot.rating),
        notes: shot.notes ?? '',
        shotDate: shotDate,
        saveAsBestDialIn: false
      };
      this.showShotForm = true;
    },

    startEditingOptimal() {
      this.editingOptimalBeanId = this.selectedBeanId;
      const b = this.selectedBean;
      this.optimalForm = {
        grindSize: b?.optimalGrindSize ?? null,
        doseIn: b?.optimalDoseIn ?? null,
        yieldOut: b?.optimalYieldOut ?? null,
        extractionTime: b?.optimalExtractionTime ?? null
      };
    },
    saveOptimalSettings() {
      const bean = this.getBeanById(this.selectedBeanId);
      if (!bean) return;
      const resolveOptimalValue = (field) => this.toNullableOneDecimal(this.optimalForm[field]) ?? SHOT_DEFAULTS[field];
      bean.optimalGrindSize = resolveOptimalValue('grindSize');
      bean.optimalDoseIn = resolveOptimalValue('doseIn');
      bean.optimalYieldOut = resolveOptimalValue('yieldOut');
      bean.optimalExtractionTime = resolveOptimalValue('extractionTime');
      this.saveBeans();
      this.editingOptimalBeanId = null;
    },
    cancelEditingOptimal() { this.editingOptimalBeanId = null; },

    openShotFormFromDaily() { this.openShotForm(this.dailySelectedBeanId); },
    openShotFormFromBean() { this.openShotForm(this.selectedBeanId); },

    closeShotForm() {
      this.editingShotId = null;
      this.showShotForm = false;
      if (this.shotFormReturnTo === 'today') {
        this.resetDailySelection();
      }
    },

    /** Get default value for shot form field:
     * editing => edited values
     * new shot numeric fields => bean best dial-in with app-default fallback */
    getShotFormDefault(field) {
      // When editing, use the shotForm values that were populated in openShotFormForEdit
      if (this.editingShotId && this.shotForm[field] != null) {
        return this.shotForm[field];
      }
      if (field === 'grindSize' || field === 'doseIn' || field === 'yieldOut' || field === 'extractionTime') {
        return this.getShotDialInDefaults(this.shotFormBeanId)[field];
      }
      return SHOT_DEFAULTS[field];
    },

    getShotFormBestDialInComparison() {
      const bean = this.getBeanById(this.shotFormBeanId);
      const current = {
        grindSize: bean?.optimalGrindSize ?? null,
        doseIn: bean?.optimalDoseIn ?? null,
        yieldOut: bean?.optimalYieldOut ?? null,
        extractionTime: bean?.optimalExtractionTime ?? null
      };
      const isEditing = !!this.editingShotId;
      const resolveNext = (field) => {
        const parsed = this.toNullableInt(this.shotForm[field]);
        if (parsed != null || isEditing) return parsed;
        return this.toNullableInt(this.getShotFormDefault(field));
      };
      const next = {
        grindSize: resolveNext('grindSize'),
        doseIn: resolveNext('doseIn'),
        yieldOut: resolveNext('yieldOut'),
        extractionTime: resolveNext('extractionTime')
      };
      const allSame = ['grindSize', 'doseIn', 'yieldOut', 'extractionTime'].every(
        f => current[f] === next[f]
      );
      return { current, next, allSame };
    },

    saveShot() {
      if (!this.shotFormBeanId) return;
      const isEditing = !!this.editingShotId;
      const resolveShotValue = (field) => {
        const parsed = this.toNullableInt(this.shotForm[field]);
        if (parsed != null || isEditing) return parsed;
        return this.toNullableInt(this.getShotFormDefault(field));
      };
      const shotData = {
        grindSize: resolveShotValue('grindSize'),
        doseIn: resolveShotValue('doseIn'),
        yieldOut: resolveShotValue('yieldOut'),
        extractionTime: resolveShotValue('extractionTime'),
        rating: this.shotForm.rating,
        notes: this.shotForm.notes || '',
        shotDate: this.shotForm.shotDate || localDateStr()
      };
      if (this.editingShotId) {
        const shot = this.shots.find(s => s.id === this.editingShotId);
        if (shot) Object.assign(shot, shotData);
        this.editingShotId = null;
      } else {
        this.shots.push({
          id: crypto.randomUUID(), beanId: this.shotFormBeanId,
          ...shotData, createdAt: new Date().toISOString()
        });
      }
      this.saveShots();
      if (this.shotForm.saveAsBestDialIn) {
        const bean = this.getBeanById(this.shotFormBeanId);
        if (bean) {
          bean.optimalGrindSize = shotData.grindSize;
          bean.optimalDoseIn = shotData.doseIn;
          bean.optimalYieldOut = shotData.yieldOut;
          bean.optimalExtractionTime = shotData.extractionTime;
          this.saveBeans();
        }
      }
      this.showShotForm = false;
      if (this.shotFormReturnTo === 'today') {
        this.resetDailySelection();
      }
    },

    deleteShot(id) {
      this.shots = this.shots.filter(s => s.id !== id);
      this.saveShots();
    },

    onDailyBeanSelect() {
      if (!this.dailySelectedBeanId) return;
      const lastShot = this.getLastShot(this.dailySelectedBeanId);
      this.dailyLastShot = lastShot;
      this.openShotFormFromDaily();
    },

    get todayFormatted() {
      const d = new Date();
      return {
        day: d.toLocaleDateString('en-US', { weekday: 'long' }),
        date: d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })
      };
    },
    formatDate(dateStr) {
      const d = /^\d{4}-\d{2}-\d{2}$/.test(dateStr) ? new Date(dateStr + 'T00:00:00') : new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    },
    formatDateTime(dateStr) {
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return 'Unknown';
      return d.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    },
    formatRoastDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + 'T00:00:00');
      return 'Roasted ' + d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    },
    getBeanOccurrence(bean) {
      // Count how many beans share the same name+roaster (including this one)
      const key = (bean.name || '').toLowerCase().trim() + '|' + (bean.roaster || '').toLowerCase().trim();
      const allMatching = this.beans.filter(b => {
        const bKey = (b.name || '').toLowerCase().trim() + '|' + (b.roaster || '').toLowerCase().trim();
        return bKey === key;
      }).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
      return allMatching.findIndex(b => b.id === bean.id) + 1;
    },

    shotQualityLabel(r) {
      const normalized = normalizeRating(r);
      if (!normalized) return null;
      return normalized.charAt(0).toUpperCase() + normalized.slice(1);
    },
    shotQualityClass(r) {
      return normalizeRating(r) || '';
    },

    getShotAssessment(shot) {
      if (!shot) return null;
      const extractionTime = Number(shot.extractionTime);
      const doseIn = Number(shot.doseIn);
      const yieldOut = Number(shot.yieldOut);
      const ratio = yieldOut / doseIn;

      // Choking: very low ratio AND low flow rate (water barely getting through)
      if (ratio < BREW_RATIO_VERY_LOW && (yieldOut / extractionTime) < 1.0) {
        return { status: 'warning', label: 'Choked/channeled \u2192 go coarser' };
      }

      // Project time to target yield (1:2)
      const t = (doseIn * 2 / yieldOut) * extractionTime;
      const belowTarget = ratio < BREW_RATIO_LOW;
      const aboveTarget = ratio > BREW_RATIO_STANDARD_MAX;
      const pullLonger = belowTarget && t <= EXTRACTION_TIME_STANDARD_MAX;
      const cutSooner = aboveTarget && t >= EXTRACTION_TIME_SLIGHTLY_FAST;

      if (t < EXTRACTION_TIME_FAST) {
        return { status: 'warning', label: 'Under-extracted \u2192 go finer' + (pullLonger ? '\nPull longer' : '') + (cutSooner ? '\nCut sooner' : '') };
      } else if (t < EXTRACTION_TIME_SLIGHTLY_FAST) {
        return { status: 'warning', label: 'Slightly under-extracted \u2192 go slightly finer' + (pullLonger ? '\nPull longer' : '') + (cutSooner ? '\nCut sooner' : '') };
      } else if (t > EXTRACTION_TIME_SLIGHTLY_SLOW) {
        return { status: 'warning', label: 'Over-extracted \u2192 go coarser' };
      } else if (t > EXTRACTION_TIME_STANDARD_MAX) {
        return { status: 'warning', label: 'Slightly over-extracted \u2192 go slightly coarser' };
      }

      // Projected time is in standard range
      if (belowTarget) {
        return { status: 'warning', label: 'Good flow \u2192 pull longer' };
      }
      if (aboveTarget) {
        return { status: 'warning', label: 'Good flow \u2192 cut sooner' };
      }
      return { status: 'good', label: 'Well-extracted' };
    },

    get calendarMonthLabel() {
      return new Date(this.calendarYear, this.calendarMonth).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    },
    prevMonth() {
      if (this.calendarMonth === 0) { this.calendarMonth = 11; this.calendarYear--; }
      else { this.calendarMonth--; }
    },
    nextMonth() {
      if (this.calendarMonth === 11) { this.calendarMonth = 0; this.calendarYear++; }
      else { this.calendarMonth++; }
    },

    toggleCalendarFilter(beanId) {
      const idx = this.calendarFilteredBeanIds.indexOf(beanId);
      if (idx === -1) {
        this.calendarFilteredBeanIds.push(beanId);
      } else {
        this.calendarFilteredBeanIds.splice(idx, 1);
      }
    },

    get calendarWeeks() {
      const first = new Date(this.calendarYear, this.calendarMonth, 1);
      const daysInMonth = new Date(this.calendarYear, this.calendarMonth + 1, 0).getDate();
      const startDay = first.getDay();
      const weeks = [];
      let week = new Array(startDay).fill(null);
      for (let d = 1; d <= daysInMonth; d++) {
        week.push(d);
        if (week.length === 7) { weeks.push(week); week = []; }
      }
      if (week.length > 0) {
        while (week.length < 7) week.push(null);
        weeks.push(week);
      }
      return weeks;
    },

    isToday(y, m, d) {
      const now = new Date();
      return now.getFullYear() === y && now.getMonth() === m && now.getDate() === d;
    },

    get calendarBars() {
      const monthStart = new Date(this.calendarYear, this.calendarMonth, 1);
      const monthEnd = new Date(this.calendarYear, this.calendarMonth + 1, 0);
      const activeBeans = this.beans
        .filter(b => b.roastDate && !b.isArchived)
        .sort((a, b) => (a.id || '').localeCompare(b.id || ''));
      const beanColorIndex = new Map();
      activeBeans.forEach((b, i) => beanColorIndex.set(b.id, i));
      const bars = [];
      for (const bean of activeBeans) {
        const roast = new Date(bean.roastDate);
        const optStart = addDays(roast, FRESHNESS_RESTING_DAYS);
        const optEnd = addDays(roast, FRESHNESS_OPTIMAL_DAYS);
        if (optEnd < monthStart || optStart > monthEnd) continue;
        const clippedStart = optStart < monthStart ? monthStart : optStart;
        const clippedEnd = optEnd > monthEnd ? monthEnd : optEnd;
        const colorIndex = beanColorIndex.get(bean.id) ?? 0;
        bars.push({
          beanId: bean.id, beanName: bean.name,
          color: BAR_COLORS[colorIndex % BAR_COLORS.length],
          startDay: clippedStart.getDate(), endDay: clippedEnd.getDate()
        });
      }
      return bars;
    },

    get calendarBarsUnique() {
      const seen = new Set();
      return this.calendarBars.filter(b => !seen.has(b.beanId) && seen.add(b.beanId));
    },

    calendarBarsForWeek(weekIndex) {
      const week = this.calendarWeeks[weekIndex];
      if (!week) return [];
      const firstDay = week.find(d => d !== null);
      const lastDay = [...week].reverse().find(d => d !== null);
      if (!firstDay || !lastDay) return [];
      const filtered = this.calendarFilteredBeanIds;
      return this.calendarBars.filter(bar =>
        bar.startDay <= lastDay && bar.endDay >= firstDay &&
        (filtered.length === 0 || filtered.includes(bar.beanId))
      );
    },

    /** Style for a smooth full-height band spanning the bar's days in this week (no gaps between cells). */
    getRangeBandStyle(bar, weekIndex) {
      const week = this.calendarWeeks[weekIndex];
      let startCol = 0, endCol = 6;
      for (let i = 0; i < 7; i++) {
        if (week[i] !== null && week[i] >= bar.startDay) { startCol = i; break; }
      }
      for (let i = 6; i >= 0; i--) {
        if (week[i] !== null && week[i] <= bar.endDay) { endCol = i; break; }
      }
      const left = (startCol / 7 * 100).toFixed(2);
      const width = ((endCol - startCol + 1) / 7 * 100).toFixed(2);
      return `left:${left}%;width:${width}%;background:${hexToRgba(bar.color, 0.22)};`;
    },
  };
}

</script>

</body>
</html>
